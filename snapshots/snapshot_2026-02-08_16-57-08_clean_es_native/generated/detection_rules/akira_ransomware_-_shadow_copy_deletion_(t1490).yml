name: Akira Ransomware - Shadow Copy Deletion (T1490)
description: Detects Akira ransomware's attempts to delete Volume Shadow Copies or
  disable system recovery options using vssadmin, wmic, or bcdedit. This action inhibits
  system recovery and maximizes impact by preventing victims from restoring encrypted
  files.
type: query
query: event.code:1 AND (process.name:(*vssadmin* OR *wmic* OR *bcdedit*) AND process.command_line:(*delete*shadows*
  OR *shadowcopy*delete* OR *recoveryenabled*no* OR *bootstatuspolicy*ignoreallfailures*))
language: lucene
index:
- logs-*
- winlogbeat-*
- filebeat-*
filters: []
risk_score: 73
severity: high
threat:
- framework: MITRE ATT&CK
  tactic:
    id: TA0040
    name: Impact
    reference: https://attack.mitre.org/tactics/TA0040/
  technique:
  - id: T1490
    name: Inhibit System Recovery
    reference: https://attack.mitre.org/techniques/T1490/
references:
- https://attack.mitre.org/techniques/T1490/
- https://www.elastic.co/guide/en/ecs/current/ecs-process.html
author:
- Detection Agent
false_positives:
- System administrators performing backup maintenance or troubleshooting
- Legitimate software uninstallers or system recovery tools
note: '## Triage

  Investigate: parent process, user context, timing, and full command line.

  Escalate if: executed by non-admin, outside of maintenance windows, or from suspicious
  parent process.'
test_cases:
- type: TP
  description: Malicious vssadmin shadow deletion
  log_entry:
    event:
      code: 1
      action: process_created
    process:
      name: vssadmin.exe
      command_line: vssadmin delete shadows /all /quiet
      executable: C:\Windows\System32\vssadmin.exe
    '@timestamp': '2024-03-12T22:15:10Z'
  expected_match: true
  evasion_technique: null
- type: TP
  description: Malicious wmic shadow copy deletion
  log_entry:
    event:
      code: 1
      action: process_created
    process:
      name: wmic.exe
      command_line: wmic shadowcopy delete
      executable: C:\Windows\System32\wbem\wmic.exe
    '@timestamp': '2024-03-12T22:15:20Z'
  expected_match: true
  evasion_technique: null
- type: TP
  description: Malicious bcdedit recovery disable
  log_entry:
    event:
      code: 1
      action: process_created
    process:
      name: bcdedit.exe
      command_line: bcdedit /set {default} recoveryenabled no
      executable: C:\Windows\System32\bcdedit.exe
    '@timestamp': '2024-03-12T22:15:30Z'
  expected_match: true
  evasion_technique: null
- type: FN
  description: PowerShell evasion using WMI API to delete shadow copies
  log_entry:
    event:
      code: 1
      action: process_created
    process:
      name: powershell.exe
      command_line: powershell.exe -Command "Get-WmiObject Win32_ShadowCopy | ForEach-Object
        {$_.Delete()}"
      executable: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
    '@timestamp': '2024-03-12T22:16:00Z'
  expected_match: false
  evasion_technique: Uses PowerShell with WMI API instead of direct CLI tools (vssadmin,
    wmic, bcdedit). Rule only covers specific process names and command line arguments.
- type: FP
  description: Admin checking shadow copy status
  log_entry:
    event:
      code: 1
      action: process_created
    process:
      name: vssadmin.exe
      command_line: vssadmin list shadows
      executable: C:\Windows\System32\vssadmin.exe
    '@timestamp': '2024-03-14T10:00:00Z'
  expected_match: false
  evasion_technique: null
- type: TN
  description: Normal system activity (explorer.exe)
  log_entry:
    event:
      code: 1
      action: process_created
    process:
      name: explorer.exe
      command_line: C:\Windows\explorer.exe
      executable: C:\Windows\explorer.exe
    '@timestamp': '2024-03-14T10:05:00Z'
  expected_match: false
  evasion_technique: null
