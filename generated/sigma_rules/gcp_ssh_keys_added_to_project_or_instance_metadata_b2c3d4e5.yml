title: GCP SSH Keys Added To Project or Instance Metadata
id: b2c3d4e5-f6g7-49i0-j1k2-l3m4n5o6p7q8
status: stable
description: Detects when SSH keys are added to project-wide or instance-specific
  metadata. Adversaries may inject their own public SSH keys to establish persistent,
  passwordless access to Compute Engine instances.
references:
- https://attack.mitre.org/techniques/T1098/004/
- https://cloud.google.com/compute/docs/connect/add-ssh-keys
author: Automated Detection Agent
date: '2024-07-29'
modified: '2024-07-31'
tags:
- attack.persistence
- attack.t1098.004
logsource:
  product: gcp
  service: gcp.audit
detection:
  selection:
    protoPayload.methodName|endswith:
    - compute.projects.setCommonInstanceMetadata
    - compute.instances.setMetadata
    protoPayload.request.metadata.items.key: ssh-keys
  filter_legitimate:
    protoPayload.authenticationInfo.principalEmail: oslogin-admin@system.gserviceaccount.com
  condition: selection and not filter_legitimate
falsepositives:
- Administrators legitimately adding or updating SSH keys for new users.
- Use of `gcloud compute ssh` which can automatically add the user's key to project
  metadata, often triggered by a user's first connection.
- Automated systems or IaC tools (Terraform, Ansible) that manage SSH key distribution.
level: high
fields:
- protoPayload.authenticationInfo.principalEmail
- resource.labels.project_id
- protoPayload.requestMetadata.callerIp
- protoPayload.request.metadata.items.value
test_scenarios:
  true_positive: An attacker with project editor rights calls 'compute.projects.setCommonInstanceMetadata'
    to add their public SSH key to the 'ssh-keys' metadata item.
  false_negative: An attacker with shell access adds their SSH key directly to the
    '~/.ssh/authorized_keys' file on a compromised VM instance without using the metadata
    service. This requires OS-level logging to detect.
  false_positive: A new developer runs `gcloud compute ssh` for the first time, and
    gcloud automatically adds their public key to the project metadata.
  true_negative: An administrator updates the 'startup-script' metadata key for an
    instance.
  log_source_schema: https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2
  example_log_fields:
    protoPayload.methodName: v1.compute.projects.setCommonInstanceMetadata
    protoPayload.request.metadata.items.key: ssh-keys
    protoPayload.authenticationInfo.principalEmail: attacker@example.com
