title: GCP User Impersonating Service Account
id: e4a7b8f1-3c5d-4b9c-8a1e-1f2g3h4i5j6k
status: experimental
description: Detects when a non-service account principal (i.e., a user) generates
  an OAuth2 access token for a service account. This is a primary privilege escalation
  vector in GCP, allowing an attacker with the 'iam.serviceAccountTokenCreator' role
  to impersonate a service account and gain all its permissions, potentially bypassing
  MFA.
references:
- https://attack.mitre.org/techniques/T1550/001/
- https://cloud.google.com/iam/docs/impersonating-service-accounts
- https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2
author: Automated Detection Agent
date: '2024-07-29'
modified: '2024-07-31'
tags:
- attack.privilege_escalation
- attack.t1550.001
logsource:
  product: gcp
  service: gcp.audit
detection:
  selection:
    protoPayload.methodName: google.iam.credentials.v1.GenerateAccessToken
  filter_legitimate:
    protoPayload.authenticationInfo.principalEmail|endswith: .gserviceaccount.com
  condition: selection and not filter_legitimate
falsepositives:
- Legitimate administrative scripts or tools that run under a user's identity to generate
  tokens for service accounts, although this is uncommon and should be audited.
- Break-glass or emergency access procedures performed by administrators.
level: high
fields:
- protoPayload.authenticationInfo.principalEmail
- protoPayload.request.name
- resource.labels.project_id
- protoPayload.requestMetadata.callerIp
test_scenarios:
  true_positive: A compromised user account 'attacker@example.com' executes 'gcloud
    iam service-accounts generate-access-token privileged-sa@...', resulting in a
    'google.iam.credentials.v1.GenerateAccessToken' log where 'principalEmail' is
    'attacker@example.com'.
  false_negative: An attacker uses a compromised service account to generate a token
    for another service account. This is a valid SA-to-SA impersonation scenario not
    covered by this rule.
  false_positive: An on-call SRE 'admin@example.com' uses a documented playbook to
    manually generate a token for a service account to debug a production issue.
  true_negative: A Cloud Build service account ('1234@cloudbuild.gserviceaccount.com')
    generates a token for a deployment service account as part of a standard CI/CD
    pipeline.
  log_source_schema: https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2
  example_log_fields:
    protoPayload.methodName: google.iam.credentials.v1.GenerateAccessToken
    protoPayload.authenticationInfo.principalEmail: attacker@external-domain.com
    protoPayload.request.name: projects/-/serviceAccounts/admin-sa@victim-project.iam.gserviceaccount.com
