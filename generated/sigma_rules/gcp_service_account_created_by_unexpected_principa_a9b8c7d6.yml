title: GCP Service Account Created by Unexpected Principal
id: a9b8c7d6-e5f6-4890-1234-567890abcdef
status: experimental
description: Detects the creation of a new IAM Service Account by an unexpected principal
  or tool. Adversaries may create new service accounts to establish a persistent backdoor.
  This rule filters for known automated principals and IaC tools.
references:
- https://attack.mitre.org/techniques/T1136/003/
- https://cloud.google.com/iam/docs/creating-managing-service-accounts
author: Automated Detection Agent
date: '2024-07-29'
modified: '2024-07-31'
tags:
- attack.persistence
- attack.t1136.003
logsource:
  product: gcp
  service: gcp.audit
detection:
  selection:
    protoPayload.methodName: google.iam.admin.v1.CreateServiceAccount
  filter_legitimate:
    principal:
      protoPayload.authenticationInfo.principalEmail|endswith:
      - .gserviceaccount.com
    tool:
      protoPayload.requestMetadata.callerSuppliedUserAgent|contains:
      - Terraform
      - Pulumi
      - Deployment Manager
      - GCP-Console-Enduser
  condition: selection and not (principal or tool)
falsepositives:
- Legitimate manual creation of service accounts by developers or administrators using
  a non-standard tool or `gcloud`.
- A new, unlisted IaC or automation tool being used to create service accounts.
level: medium
fields:
- protoPayload.authenticationInfo.principalEmail
- protoPayload.request.accountId
- resource.labels.project_id
- protoPayload.requestMetadata.callerIp
- protoPayload.requestMetadata.callerSuppliedUserAgent
test_scenarios:
  true_positive: An attacker, having compromised a developer's account, uses a custom
    script to create a new service account named 'gcp-backup-svc' to use as a backdoor.
  false_negative: An attacker uses Terraform to create a service account, which would
    be filtered by the 'tool' filter.
  false_positive: A developer uses `gcloud iam service-accounts create` to legitimately
    create a service account for a new application.
  true_negative: A Cloud Build service account creates another service account as
    part of a pipeline, which is filtered by the 'principal' filter.
  log_source_schema: https://cloud.google.com/logging/docs/audit/gcp-audit-logs-v2
  example_log_fields:
    protoPayload.methodName: google.iam.admin.v1.CreateServiceAccount
    protoPayload.authenticationInfo.principalEmail: compromised-user@example.com
    protoPayload.request.accountId: backdoor-sa
