{
  "name": "Akira Ransomware - Shadow Copy & Recovery Disruption",
  "description": "Detects Akira ransomware's attempts to inhibit system recovery by deleting shadow copies and disabling boot recovery options. This is a critical step before encryption to prevent data restoration. This rule monitors for specific command-line utilities and arguments used by Akira.",
  "type": "query",
  "query": "event.code:1 AND (process.name:(*vssadmin* OR *wmic* OR *bcdedit*) AND process.command_line:(*delete*shadows* OR *shadowcopy*delete* OR *recoveryenabled*no* OR *bootstatuspolicy*ignoreallfailures*))",
  "language": "lucene",
  "index": [
    "winlogbeat-*",
    "logs-endpoint.events.process-*"
  ],
  "filters": [],
  "risk_score": 85,
  "severity": "high",
  "threat": [
    {
      "framework": "MITRE ATT&CK",
      "tactic": {
        "id": "TA0040",
        "name": "Impact",
        "reference": "https://attack.mitre.org/tactics/TA0040/"
      },
      "technique": [
        {
          "id": "T1490",
          "name": "Inhibit System Recovery",
          "reference": "https://attack.mitre.org/techniques/T1490/"
        }
      ]
    }
  ],
  "references": [
    "https://attack.mitre.org/techniques/T1490/",
    "https://www.elastic.co/guide/en/ecs/current/ecs-process.html",
    "https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-query-string-query.html"
  ],
  "author": [
    "Detection Agent"
  ],
  "false_positives": [
    "System administrators performing backup maintenance or system configuration changes",
    "Legitimate software uninstallers or recovery tools"
  ],
  "note": "## Triage\nInvestigate: parent process, user context, timing, and frequency of execution. Correlate with other suspicious activity.\nEscalate if: executed by non-admin, from an unusual parent process, outside of maintenance windows, or in conjunction with other suspicious activity.",
  "test_cases": [
    {
      "type": "TP",
      "description": "Malicious vssadmin shadow deletion",
      "log_entry": {
        "event": {
          "code": 1,
          "provider": "Microsoft-Windows-Sysmon"
        },
        "process": {
          "name": "vssadmin.exe",
          "command_line": "vssadmin delete shadows /all /quiet",
          "executable": "C:\\Windows\\System32\\vssadmin.exe"
        },
        "@timestamp": "2024-03-12T22:15:10Z"
      },
      "expected_match": true,
      "evasion_technique": null
    },
    {
      "type": "TP",
      "description": "Malicious wmic shadow copy deletion",
      "log_entry": {
        "event": {
          "code": 1,
          "provider": "Microsoft-Windows-Sysmon"
        },
        "process": {
          "name": "wmic.exe",
          "command_line": "wmic shadowcopy delete",
          "executable": "C:\\Windows\\System32\\wbem\\wmic.exe"
        },
        "@timestamp": "2024-03-12T22:15:20Z"
      },
      "expected_match": true,
      "evasion_technique": null
    },
    {
      "type": "TP",
      "description": "Malicious bcdedit recovery disable",
      "log_entry": {
        "event": {
          "code": 1,
          "provider": "Microsoft-Windows-Sysmon"
        },
        "process": {
          "name": "bcdedit.exe",
          "command_line": "bcdedit /set {default} recoveryenabled no",
          "executable": "C:\\Windows\\System32\\bcdedit.exe"
        },
        "@timestamp": "2024-03-12T22:15:30Z"
      },
      "expected_match": true,
      "evasion_technique": null
    },
    {
      "type": "FN",
      "description": "PowerShell evasion using WMI API to delete shadow copies",
      "log_entry": {
        "event": {
          "code": 1,
          "provider": "Microsoft-Windows-Sysmon"
        },
        "process": {
          "name": "powershell.exe",
          "command_line": "powershell.exe -Command \"Get-WmiObject Win32_ShadowCopy | ForEach-Object {$_.Delete()}\"",
          "executable": "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe"
        },
        "@timestamp": "2024-03-12T22:16:00Z"
      },
      "expected_match": false,
      "evasion_technique": "Uses WMI API via PowerShell instead of direct vssadmin/wmic/bcdedit commands. This rule focuses on specific command-line utilities."
    },
    {
      "type": "FN",
      "description": "Evasion by renaming vssadmin.exe",
      "log_entry": {
        "event": {
          "code": 1,
          "provider": "Microsoft-Windows-Sysmon"
        },
        "process": {
          "name": "custom_vss.exe",
          "command_line": "custom_vss.exe delete shadows /all /quiet",
          "executable": "C:\\Windows\\Temp\\custom_vss.exe"
        },
        "@timestamp": "2024-03-12T22:16:10Z"
      },
      "expected_match": false,
      "evasion_technique": "The vssadmin.exe executable was renamed, bypassing detection based on process.name."
    },
    {
      "type": "FP",
      "description": "Administrator listing shadow copies",
      "log_entry": {
        "event": {
          "code": 1,
          "provider": "Microsoft-Windows-Sysmon"
        },
        "process": {
          "name": "vssadmin.exe",
          "command_line": "vssadmin list shadows",
          "executable": "C:\\Windows\\System32\\vssadmin.exe"
        },
        "@timestamp": "2024-03-14T10:00:00Z"
      },
      "expected_match": false,
      "evasion_technique": null
    },
    {
      "type": "FP",
      "description": "Administrator checking bcdedit configuration",
      "log_entry": {
        "event": {
          "code": 1,
          "provider": "Microsoft-Windows-Sysmon"
        },
        "process": {
          "name": "bcdedit.exe",
          "command_line": "bcdedit /enum all",
          "executable": "C:\\Windows\\System32\\bcdedit.exe"
        },
        "@timestamp": "2024-03-14T10:05:00Z"
      },
      "expected_match": false,
      "evasion_technique": null
    },
    {
      "type": "TN",
      "description": "Normal system activity (explorer.exe)",
      "log_entry": {
        "event": {
          "code": 1,
          "provider": "Microsoft-Windows-Sysmon"
        },
        "process": {
          "name": "explorer.exe",
          "command_line": "C:\\Windows\\explorer.exe",
          "executable": "C:\\Windows\\explorer.exe"
        },
        "@timestamp": "2024-03-14T10:10:00Z"
      },
      "expected_match": false,
      "evasion_technique": null
    }
  ]
}